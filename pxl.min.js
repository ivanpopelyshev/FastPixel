var pxl=function(t){"use strict";var e=null,i=!0,n=null,s=null;try{if(n=t.createElement("CANVAS"),n.width=n.height=1,s=n.getContext("2d"),e=Object.getPrototypeOf(s.getImageData(0,0,1,1).data).constructor,!(new e).buffer)throw new Error}catch(r){i=!1}return{MIN_ZOOM_SCALE:1,MAX_ZOOM_SCALE:64,MIN_PEN_SIZE:1,MAX_PEN_SIZE:5,MIN_CANVAS_SIZE:8,MAX_CANVAS_SIZE:1024,MAX_LAYER_COUNT:8,MAX_HISTORY_SIZE:20,PIXELS_CHANGED_EVENT:"pixelsChanged",ImageDataArray:e,activeView:null,isSupported:function(){return i},clamp:function(t,e,i){return t>i?i:e>t?e:t},createImageData:function(){return s.createImageData.apply(s,arguments)},createCanvas:function(){return n.cloneNode()}}}(document);!function(t){"use strict";function e(t){return 0>t?(0|t)-1:0|t}function i(t){return t+.5|0}function n(t){return t===(0|t)?t:(0|t)+1}if(t){var s=t.Vector2=function(t,e){this.set(t||0,e)};s.EPSILON=1e-10;var r=s.prototype;r.toString=function(){return'{"x":'+this.x+',"y":'+this.y+"}"},r.add=function(t,e){return t instanceof s?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+="number"==typeof e?e:t),this},r.sub=function(t,e){return t instanceof s?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-="number"==typeof e?e:t),this},r.mul=function(t,e){return t instanceof s?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*="number"==typeof e?e:t),this},r.div=function(t,e){return t instanceof s?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/="number"==typeof e?e:t),this},r.set=function(t,e){return t instanceof s?(this.x=t.x,this.y=t.y):(this.x=t,this.y="number"==typeof e?e:t),this},r.cmp=function(t,e){var i=s.EPSILON;return t instanceof s?Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i:Math.abs(this.x-t)<i&&Math.abs(this.y-("number"==typeof e?e:t))<i},r.abs=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},r.neg=function(){return this.x>=0&&(this.x=-this.x),this.y>=0&&(this.y=-this.y),this},r.swap=function(t){var e=t.x;return t.x=this.x,this.x=e,e=t.y,t.y=this.y,this.y=e,this},r.floor=function(){return this.x=e(this.x),this.y=e(this.y),this},r.ceil=function(){return this.x=n(this.x),this.y=n(this.y),this},r.round=function(){return this.x=i(this.x),this.y=i(this.y),this},r.hasNaN=function(){return this.x!==this.x||this.y!==this.y},r.hasInfinity=function(){return!isFinite(this.x)||!isFinite(this.y)},r.clone=function(){return new s(this)}}}(pxl),function(t){"use strict";if(t){var e=t.Observer=function(){this._eventBook={}},i=e.prototype;i.subscribe=function(t,e){if(t in this._eventBook){var i=this._eventBook[t];-1===i.indexOf(e)&&i.push(e)}else this._eventBook[t]=[e]},i.unsubscribe=function(t,e){if(t in this._eventBook){var i=this._eventBook[t],n=i.indexOf(e);-1!==n&&i.splice(n,1)}},i.notify=function(t,e){if(t in this._eventBook)for(var i=this._eventBook[t],n=0;n<i.length;++n)i[n](e)}}}(pxl),function(t){"use strict";if(t){var e=t.GrovingPool=function(t){this._container=[new t],this._allocator=t,this._size=0},i=e.prototype;i.size=function(){return this._size},i.isFull=function(){return this._size===this._container.length},i.isEmpty=function(){return 0===this._container.length},i.expand=function(){var t=null;return this._size===this._container.length?(t=new this._allocator,this._size=this._container.push(t),t):this._container[this._size++]},i.pop=function(){return 0===this._size?null:this._container[--this._size]},i.at=function(t){return t<this._size||0>t?this._container[t]:null},i.back=function(){return 0===this._size?null:this._container[this._size-1]},i.reduce=function(){this._size=0},i.shrink=function(){this._container.length=this._size},i.free=function(){this._container.length=this._size=0}}}(pxl),function(){"use strict";var t=pxl.Layout=function(){this._imageData=pxl.createImageData.apply(null,arguments),this.dataLayer=new pxl.Layout.Layer({source:this._imageData.data.buffer,layout:this}),this.layerList=[],this.activeLayer=null,this.observer=new pxl.Observer},e=t.prototype;e.appendLayer=function(){return this.layerList.length<pxl.MAX_LAYER_COUNT&&(this.activeLayer=new t.Layer({source:this.getWidth()*this.getHeight(),layout:this,name:"Layer "+this.layerList.length}),this.layerList.push(this.activeLayer)),this},e.deleteLayer=function(){for(var t=this.layerList,e=t.length,i=0;e>i;++i)if(t[i]===this.activeLayer){t.splice(i,1),this.activeLayer.destroy(),this.activeLayer=0===t.length?null:t[e-1];break}return this},e.mergeLayers=function(t){var e={},i=this.visibleLayers(),n=i.length,s=this.dataLayer;if(n){t.start&&t.offset?(e.start=t.start,e.offset=t.offset,e.other=i[0],e.isMix=!1,s.merge(e)):s.copy(i[0]),e.isMix=!!t.isMix;for(var r=1;n>r;++r)e.other=i[r],s.merge(e)}else s.reset();return t.isNotifyView===!0&&this.observer.notify(pxl.PIXELS_CHANGED_EVENT,t),this},e.colorReplace=function(t){return this.activeLayer.colorReplace(t),this.mergeLayers(t),this},e.plot=function(t){return this.activeLayer.plot(t),this.mergeLayers(t),this},e.fill=function(t){return this.activeLayer.fill(t)&&this.mergeLayers(t),this},e.indexesAt=function(){var t=[0];return function(e){var i=t,n=e.start,s=Math.max(0,n.x),r=Math.max(0,n.y),a=Math.min(this.getWidth()-1,e.offset.x),o=a*Math.min(this.getHeight()-1,e.offset.y),h=new pxl.Vector2,u=0,l=this.indexAt(n);i.length=o;for(var c=0;o>c;++c)i[c]=l+u,++u>=a&&(u=0,l=this.indexAt(h.set(s,++r)));return i}}(),e.indexAt=function(t){return t.x+t.y*this.getWidth()},e.positionFrom=function(t){var e=this.getWidth();return new pxl.Vector2(t%e,t/e|0)},e.getImageData=function(t){var e=null;if(t){e=pxl.createImageData(t.offset.x,t.offset.y);for(var i=new pxl.Layout.Layer.Pixel(new pxl.ImageDataArray(e.data.buffer)),n=new pxl.Layout.Layer.Pixel(this.dataLayer.data),s=this.indexesAt(t),r=s.length,a=0,o=0;r>a;++a)i.index=o,n.index=s[a]<<2,i.set(n),o+=4}else e=this._imageData;return e},e.getWidth=function(){return this._imageData.width},e.getHeight=function(){return this._imageData.height},e.visibleLayers=function(){for(var t=[],e=this.layerList,i=0;i<e.length;++i)e[i].isVisible&&t.push(e[i]);return t},e.isWithinLayout=function(t){return t.x>=0&&t.x<this.getWidth()&&t.y>=0&&t.y<this.getHeight()},e.destroy=function(){for(this.dataLayer.destroy(),this.dataLayer=this.activeLayer=null;this.layerList.length;)this.layerList.pop().destroy();this._imageData=null}}(),function(){"use strict";var t=pxl.Layout.Layer=function(t){this.data=new pxl.ImageDataArray("number"==typeof t.source?t.source<<2:t.source),this.name=t.name||"",this.isVisible=!0,this._layout=t.layout},e=t.prototype;e.reset=function(){var t=this.data;if("fill"in pxl.ImageDataArray.prototype)t.fill(0);else for(var e=0,i=t.length;i>e;++e)t[e]=0},e.copy=function(t,e){this.data.set(t.data),e===!0&&(this.name=t.name,this._layout=t._layout,this.isVisible=t.isVisible)},e.merge=function(t){var e=0,i=0,n=t.isMix===!0?"mix":"set",s=new pxl.Layout.Layer.Pixel(this.data),r=new pxl.Layout.Layer.Pixel(t.other.data);if(t.start&&t.offset||t.indexes){var a=t.indexes||this._layout.indexesAt(t);for(i=a.length,e=0;i>e;++e)s.index=r.index=a[e]<<2,s[n](r)}else for(i=this.data.length,e=0;i>e;e+=4)s.index=r.index=e,s[n](r)},e.fill=function(){var t=new pxl.GrovingPool(pxl.Vector2);return function(e){function i(){s.index=u.indexAt(h)<<2,s.compare(r)&&(o.cache(s),s.set(p),a.expand().set(h))}var n=this._layout.indexAt(e.position),s=new pxl.Layout.Layer.Pixel(this.data,n<<2);if(s.compare(e.pixel))return!1;var r=new pxl.ImageDataArray(this.pixelFromIndex(n)),a=t,o=pxl.Layout.history,h=new pxl.Vector2,u=this._layout,l=0,c=0,f=0,x=0;e.start&&e.offset?(l=Math.max(0,e.start.y),c=Math.min(u.getWidth()-1,e.start.x+e.offset.x),x=Math.min(u.getHeight()-1,e.start.y+e.offset.y),f=Math.max(0,e.start.x)):(c=u.getWidth()-1,x=u.getHeight()-1),o.cache(s),s[e.isMix===!0?"mix":"set"](e.pixel);var p=this.pixelFromIndex(n);a.expand().set(e.position);do h.set(a.pop()),h.y>l&&(h.y-=1,i(),h.y+=1),h.x<c&&(h.x+=1,i(),h.x-=1),h.y<x&&(h.y+=1,i(),h.y-=1),h.x>f&&(h.x-=1,i(),h.x+=1);while(a._size);return a.reduce(),!0}}(),e.plot=function(t){var e=0,i=0,n=t.pixel,s=pxl.Layout.history,r=t.isMix===!0?"mix":"set",a=new pxl.Layout.Layer.Pixel(this.data);if(t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(i=o.length,e=0;i>e;++e)a.index=o[e]<<2,s.cache(a),a[r](n)}else for(i=this.data.length,e=0;i>e;e+=4)a.index=e,s.cache(a),a[r](n)},e.colorReplace=function(t){var e=0,i=0,n=pxl.Layout.history,s=new pxl.Layout.Layer.Pixel(this.data),r=new pxl.ImageDataArray(t.oldPixel),a=new pxl.Layout.Layer.Pixel(t.oldPixel);if(a[t.isMix===!0?"mix":"set"](t.pixel),t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(i=o.length,e=0;i>e;++e)s.index=o[e]<<2,s.compare(r)&&(n.cache(s),s.set(a))}else for(i=this.data.length,e=0;i>e;e+=4)s.index=e,s.compare(r)&&(n.cache(s),s.set(a))},e.pixelFromPosition=function(t){return this.pixelAt(this._layout.indexAt(t)<<2)},e.pixelFromIndex=function(t){return this.pixelAt(t<<=2)},e.getLayout=function(){return this._layout},e.pixelAt=function(t){return this.data.subarray(t,t+4)},e.destroy=function(){this._layout=this.data=null,this.isVisible=!1,pxl.Layout.history.clean()}}(),function(){"use strict";var t=pxl.Layout.Layer.Pixel=function(t,e){this.data=t,this.index=e||0},e=t.prototype;e.toString=function(){var t=this.data,e=this.index;return t[e]+","+t[++e]+","+t[++e]+","+t[++e]},e.compare=function(t){var e=this.data,i=this.index,n=t.data||t,s=t.index||0;return e[i]===n[s]&&e[++i]===n[++s]&&e[++i]===n[++s]&&e[++i]===n[++s]},e.isOpaque=function(){return 255===this.data[this.index+3]},e.isTransparent=function(){return 0===this.data[this.index+3]},e.set=function(t){var e=this.data,i=this.index,n=t.data||t,s=t.index||0;e[i]=n[s],e[++i]=n[++s],e[++i]=n[++s],e[++i]=n[++s]},e.mix=function(t){var e=this.data,i=this.index,n=t.data||t,s=t.index||0,r=n[s+3];if(0!==r){var a=e[i+3];if(255===r||0===a)return void this.set(t);a/=255,r/=255;var o=a*(1-r),h=r+o,u=r/h,l=o/h;e[i]=e[i++]*u+n[s+0]*l,e[i]=e[i++]*u+n[s+1]*l,e[i]=e[i++]*u+n[s+2]*l,e[i]=255*h}}}(),function(){"use strict";function t(t){return"imageSmoothingEnabled"in t?t.imageSmoothingEnabled=!1:"webkitImageSmoothingEnabled"in t?t.webkitImageSmoothingEnabled=!1:"mozImageSmoothingEnabled"in t?t.mozImageSmoothingEnabled=!1:"msImageSmoothingEnabled"in t&&(t.msImageSmoothingEnabled=!1),t}function e(t){t._buffer=t._layout=null}function i(t,e){return e*(1-t)>>1}var n=pxl.Layout.View=function(t){this._buffer=t.buffer,this._ctx=t.ctx,this._layoutOwner=t.isOwner,this._imagePoint=new pxl.Vector2(0),this._scale=pxl.MIN_ZOOM_SCALE,this._layout=t.layout,this._subscribe()};n.create=function(e){var i=null,s=null,r=null,a=!0;i=e.element?"CANVAS"===e.element.nodeName.toUpperCase()?e.element:e.element.appendChild(pxl.createCanvas()):document.body.appendChild(pxl.createCanvas()),e.source?(s=e.source._buffer.canvas,r=e.source._layout,a=!1):(s=pxl.createCanvas(),s.width=pxl.clamp(e.canvasSize.width,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),s.height=pxl.clamp(e.canvasSize.height,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),r=new pxl.Layout(s.width,s.height).appendLayer());var o=new n({buffer:t(s.getContext("2d")),ctx:t(i.getContext("2d")),isOwner:a,layout:r});return n.instances.push(o),o},n.instances=[];var s=n.prototype;s.render=function(t){return t=t||{},this.clear(t).update(t).redraw(t)},s.drawRect=function(t){var e=t.pixel;return this._ctx.fillStyle="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]/255+")",this._ctx.fillRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y),this},s.redraw=function(t){return t.start&&t.offset?this._ctx.drawImage(this._buffer.canvas,t.start.x,t.start.y,t.offset.x,t.offset.y,t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.drawImage(this._buffer.canvas,this._imagePoint.x,this._imagePoint.y),this},s.clear=function(t){return t.start&&t.offset?this._ctx.clearRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this},s.update=function(t){return this._layoutOwner&&(t.start&&t.offset?this._buffer.putImageData(this._layout.getImageData(t),t.start.x,t.start.y,0,0,t.offset.x,t.offset.y):this._buffer.putImageData(this._layout.getImageData(),0,0)),this},s.begin=function(){var t=this._scale,e=this._ctx;return e.save(),e.translate(i(t,this._ctx.canvas.width),i(t,this._ctx.canvas.height)),e.scale(t,t),this},s.end=function(){return this._ctx.restore(),this},s.getBufferContext=function(){return this._buffer},s.getScale=function(){return this._scale},s.getElement=function(){return this._ctx.canvas},s.getLayout=function(){return this._layout},s.getImagePoint=function(){return this._imagePoint},s.getScaleOffset=function(){return new pxl.Vector2(i(this._scale,this._ctx.canvas.width),i(this._scale,this._ctx.canvas.height))},s.setScale=function(t){return this._scale=pxl.clamp(t,pxl.MIN_ZOOM_SCALE,pxl.MAX_ZOOM_SCALE),this},s.setLayout=function(t){var e=n.instances;this.deleteLayout(),this._layout=t,this._subscribe(),this._layoutOwner=!0;for(var i=0;i<e.length;++i)if(e[i]!==this&&t===e[i]._layout){this._layoutOwner=!1;break}return this},s.setImagePoint=function(t,e){return this.fitToTransition(this._imagePoint.set(t,e))},s.fitToTransition=function(t){return t.sub(this.getScaleOffset()).div(this._scale).floor(),this},s.resizeElement=function(e,i){return this._ctx.canvas.style.width=e+"px",this._ctx.canvas.style.height=i+"px",this._ctx.canvas.width=e,this._ctx.canvas.height=i,t(this._ctx),this.redraw({})},s.deleteLayout=function(){var t=n.instances;if(this._unsubscribe(),this._layoutOwner){for(var i=0;i<t.length;++i)this!==t[i]&&this._layout===t[i]._layout&&(t[i]._unsubscribe(),e(t[i]));this._layout.destroy(),e(this)}return this},s._subscribe=function(){return this._boundedRender||(this._boundedRender=this.render.bind(this),this._layout.observer.subscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender)),this},s._unsubscribe=function(){return this._layout.observer.unsubscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender),this._boundedRender=null,this},s.destroy=function(){var t=n.instances;this.deleteLayout();for(var e=0;e<t.length;++e)if(this===t[e]){t.splice(e,1);break}}}(),function(){"use strict";pxl.Layout.history={_container:[],_pointer:0,_isRecording:!1,lastSession:null,undo:function(){this._pointer&&this._rewrite(this._container[--this._pointer])},redo:function(){this._pointer<this._container.length&&this._rewrite(this._container[this._pointer++])},cache:function(t){if(this._isRecording){var e=this.lastSession.pixelMap,i=t.toString();i in e?e[i].push(t.index):(this.lastSession.assoc.push(i),e[i]=[t.index])}},isEmptySession:function(){for(var t in this._container[this._pointer].pixelMap)return!0;return!1},record:function(t){this.lastSession||(this.lastSession={pixelMap:{},assoc:[],layer:t}),this._isRecording=!0},stop:function(){this.lastSession.assoc.length&&(this._pointer<pxl.MAX_HISTORY_SIZE?(this._container[this._pointer++]=this.lastSession,this._container.splice(this._pointer,this._container.length)):(this._container.push(this.lastSession),this._container.shift()),this.lastSession=null,this._isRecording=!1)},getCurrentSession:function(){return this._container.length?this._pointer?this._container[this._pointer-1]:this._container[this._pointer]:null},clean:function(){for(var t=this._container,e=null,i=0;i<t.length;++i)e=t[i],e.layer&&null!==e.layer.data||(e===t[this._pointer]&&(t.length>1?0!==this._pointer&&--this._pointer:this._pointer=0),t.splice(i,1))},_rewrite:function(t){for(var e=new pxl.Layout.Layer.Pixel(t.layer.data),i=new pxl.ImageDataArray(4),n=t.pixelMap,s=null,r=0,a=0,o={},h=[],u=[],l=0,c="";t.assoc.length;)for(c=t.assoc.pop(),i.set(c.split(",")),s=n[c],r=s.length,a=0;r>a;++a)l=e.index=s[a],l in u||(u[l]=!1,c=e.toString(),c in o?o[c].push(l):(h.push(c),o[c]=[l])),e.set(i);t.pixelMap=o,t.assoc=h}}}(),function(){"use strict";function t(t){return function(){var i=e.getCurrentSession();return i&&(e[t](),i.layer.getLayout().mergeLayers({isNotifyView:!0})),pxl.Layout.controller}}var e=pxl.Layout.history;pxl.Layout.controller={_settings:{current:new pxl.Vector2,previous:new pxl.Vector2,pixel:new pxl.ImageDataArray([0,0,0,255]),pixelSize:pxl.MIN_PEN_SIZE},updateUserPosition:function(t,e){return this._settings.previous.set(this._settings.current),pxl.activeView.fitToTransition(this._settings.current.set(t,e).abs().floor()),this._settings.current.sub(pxl.activeView.getImagePoint()),this},positionUpdated:function(){return!this._settings.previous.cmp(this._settings.current)},plotPixel:function(){var t={start:new pxl.Vector2,offset:new pxl.Vector2,indexes:null,pixel:null,isMix:!0,isNotifyView:!0};return function(e,i){var n=pxl.activeView.getLayout();arguments.length?t.start.set(e,i):t.start.set(this._settings.current),t.offset.set(this._settings.pixelSize),t.indexes=n.indexesAt(t),t.pixel=this._settings.pixel,n.plot(t)}}(),plotLine:function(t,e,i,n){arguments.length||(t=this._settings.current.x,e=this._settings.current.y,i=this._settings.previous.x,n=this._settings.previous.y);for(var s=Math.abs(i-t),r=-Math.abs(n-e),a=i>t?1:-1,o=n>e?1:-1,h=s+r,u=0;this.plotPixel(t,e),t!==i||e!==n;)u=h+h,u>=r&&(h+=r,t+=a),s>=u&&(h+=s,e+=o)},fill:function(t,e){var i=arguments.length?new pxl.Vector2(t,e):new pxl.Vector2(this._settings.current);pxl.activeView.fitToTransition(i),pxl.activeView.getLayout().fill({position:i,pixel:this._settings.pixel,isMix:!0,isNotifyView:!0})},carryPixel:function(){var t={start:new pxl.Vector2,offset:new pxl.Vector2(pxl.MIN_PEN_SIZE),pixel:null};return function(){var e=pxl.activeView;e.getScaleOffset(),e.getScale();return t.start.set(this._settings.previous),e.clear(t).redraw(t),t.offset.set(this._settings.pixelSize),t.start.set(this._settings.current),t.pixel=this._settings.pixel,e.drawRect(t),this}}(),undo:t("undo"),redo:t("redo"),rescale:function(t){var e={};return pxl.activeView.clear(e).setScale(pxl.activeView.getScale()+t).begin().redraw(e).end(),this},setPixelSize:function(t){return this._settings.pixelSize=pxl.clamp(t,pxl.MIN_PEN_SIZE,pxl.MAX_PEN_SIZE),this},setColor:function(t,e,i,n){return this._settings.pixel.set(Array.prototype.slice.call(arguments)),this},startRecord:function(){return e.record(pxl.activeView.getLayout().activeLayer),this},stopRecord:function(){return e.stop(),this},record:function(t){return t.call(this.startRecord()),this.stopRecord()},startDraw:function(){return pxl.activeView.begin(),this},stopDraw:function(){return pxl.activeView.end(),this},draw:function(t){return t.call(this.startDraw()),this.stopDraw()},removeActiveView:function(){return pxl.activeView.clear({}),pxl.activeView.destroy(),pxl.activeView=null,this},moveView:function(t,e){return pxl.activeView.setImagePoint(t,e).redraw({}),this}}}();