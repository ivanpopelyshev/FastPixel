var pxl=function(t){"use strict";var i=null,e=!0,n=null,s=null;try{if(n=t.createElement("CANVAS"),n.width=n.height=1,s=n.getContext("2d"),i=Object.getPrototypeOf(s.getImageData(0,0,1,1).data).constructor,!(new i).buffer)throw new Error}catch(a){e=!1}return{MIN_ZOOM_SCALE:1,MAX_ZOOM_SCALE:64,MIN_PEN_SIZE:1,MAX_PEN_SIZE:5,MIN_CANVAS_SIZE:4,MAX_CANVAS_SIZE:1024,MAX_LAYER_COUNT:8,MAX_HISTORY_SIZE:20,PIXELS_CHANGED_EVENT:"pixelsChanged",ImageDataArray:i,activeView:null,isSupported:function(){return e},clamp:function(t,i,e){return t>e?e:i>t?i:t},createImageData:function(){return s.createImageData.apply(s,arguments)},createCanvas:function(){return n.cloneNode()}}}(document);!function(t){"use strict";function i(t){return 0>t?(0|t)-1:0|t}function e(t){return t+.5|0}function n(t){return t===(0|t)?t:(0|t)+1}if(t){var s=t.Vector2=function(t,i){this.set(t||0,i)};s.EPSILON=1e-10;var a=s.prototype;a.toString=function(){return'{"x":'+this.x+',"y":'+this.y+"}"},a.add=function(t,i){return t instanceof s?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+="number"==typeof i?i:t),this},a.sub=function(t,i){return t instanceof s?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-="number"==typeof i?i:t),this},a.mul=function(t,i){return t instanceof s?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*="number"==typeof i?i:t),this},a.div=function(t,i){return t instanceof s?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/="number"==typeof i?i:t),this},a.set=function(t,i){return t instanceof s?(this.x=t.x,this.y=t.y):(this.x=t,this.y="number"==typeof i?i:t),this},a.cmp=function(t,i){return t instanceof s?Math.abs(this.x-t.x)<s.EPSILON&&Math.abs(this.y-t.y)<s.EPSILON:Math.abs(this.x-t)<s.EPSILON&&Math.abs(this.y-("number"==typeof i?i:t))<s.EPSILON},a.abs=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},a.neg=function(){return this.x>=0&&(this.x=-this.x),this.y>=0&&(this.y=-this.y),this},a.swap=function(t){var i=t.x;return t.x=this.x,this.x=i,i=t.y,t.y=this.y,this.y=i,this},a.floor=function(){return this.x=i(this.x),this.y=i(this.y),this},a.ceil=function(){return this.x=n(this.x),this.y=n(this.y),this},a.round=function(){return this.x=e(this.x),this.y=e(this.y),this},a.hasNaN=function(){return this.x!==this.x||this.y!==this.y},a.hasInfinity=function(){return!isFinite(this.x)||!isFinite(this.y)},a.clone=function(){return new s(this)}}}(pxl),function(t){"use strict";if(t){var i=t.Observer=function(){this._eventBook={}},e=i.prototype;e.subscribe=function(t,i){if(t in this._eventBook){var e=this._eventBook[t];-1===e.indexOf(i)&&e.push(i)}else this._eventBook[t]=[i]},e.unsubscribe=function(t,i){if(t in this._eventBook){var e=this._eventBook[t],n=e.indexOf(i);-1!==n&&(e.splice(n,1),0===e.length&&delete this._eventBook[t])}},e.notify=function(t,i){if(t in this._eventBook)for(var e=this._eventBook[t],n=0;n<e.length;++n)e[n](i)}}}(pxl),function(t){"use strict";if(t){var i=t.GrowingPool=function(t){this._container=[new t],this._allocator=t,this._size=0},e=i.prototype;e.size=function(){return this._size},e.isFull=function(){return this._size===this._container.length},e.isEmpty=function(){return 0===this._container.length},e.expand=function(){var t=null;return this._size===this._container.length?(t=new this._allocator,this._size=this._container.push(t),t):this._container[this._size++]},e.pop=function(){return 0===this._size?null:this._container[--this._size]},e.at=function(t){return t<this._size||0>t?this._container[t]:null},e.back=function(){return 0===this._size?null:this._container[this._size-1]},e.reduce=function(){this._size=0},e.shrink=function(){this._container.length=this._size},e.free=function(){this._container.length=this._size=0}}}(pxl),function(t){"use strict";if(t)var i=t.bresenham={line:function(t,i,e,n,s){var a=e-t;0>a&&(a=-a);var r=n-i;r>0&&(r=-r);for(var o=e>t?1:-1,h=n>i?1:-1,u=a+r,l=0;s(t,i),t!==e||i!==n;)l=u+u,l>=r&&(u+=r,t+=o),a>=l&&(u+=a,i+=h)},rect:function(t,e,n,s,a){i.line(t,e,n,e),i.line(n,e,n,s),i.line(n,s,t,s),i.line(t,s,t,e)},ellipse:function(t,i,e,n,s){var a=e-t;0>a&&(a=-a);var r=n-i;0>r&&(r=-r);var o=1&r,h=4*(1-a)*r*r,u=4*(o+1)*a*a,l=h+u+o*a*a,c=0;t>e&&(t=e,e+=a),i>n&&(i=n),i+=r+1>>1,n=i-o,a=8*a*a,o=8*r*r;do s(e,i),s(t,i),s(t,n),s(e,n),c=l<<1,u>=c&&(++i,--n,l+=u+=a),(c>=h||l<<1>u)&&(++t,--e,l+=h+=o);while(e>=t);for(;r>=i-n;)s(t-1,i),s(e+1,i++),s(t-1,n),s(e+1,n--)}}}(pxl),function(){"use strict";var t=pxl.Layout=function(){this._imageData=pxl.createImageData.apply(null,arguments),this.dataLayer=new pxl.Layout.Layer({source:this._imageData.data.buffer,layout:this}),this.layerList=[],this.activeLayer=null,this.observer=new pxl.Observer},i=t.prototype;i.appendLayer=function(){return this.layerList.length<pxl.MAX_LAYER_COUNT&&(this.activeLayer=new t.Layer({source:this.getWidth()*this.getHeight(),layout:this,name:"Layer "+this.layerList.length}),this.layerList.push(this.activeLayer)),this},i.deleteLayer=function(){for(var t=this.layerList,i=t.length,e=0;i>e;++e)if(t[e]===this.activeLayer){t.splice(e,1),this.activeLayer.destroy(),this.activeLayer=0===t.length?null:t[i-1];break}return this},i.mergeLayers=function(t){var i={},e=this.visibleLayers(),n=e.length,s=this.dataLayer;if(n){t.start&&t.offset?(i.start=t.start,i.offset=t.offset,i.other=e[0],i.isMix=!1,s.merge(i)):s.copy(e[0]),i.isMix=!!t.isMix;for(var a=1;n>a;++a)i.other=e[a],s.merge(i)}else s.reset();return t.isNotifyView===!0&&this.observer.notify(pxl.PIXELS_CHANGED_EVENT,t),this},i.colorReplace=function(t){return this.activeLayer.colorReplace(t),this.mergeLayers(t),this},i.plot=function(t){return this.activeLayer.plot(t),this.mergeLayers(t),this},i.fill=function(t){return this.activeLayer.fill(t)&&this.mergeLayers(t),this},i.indexesAt=function(){var t=[0];return function(i){var e=t,n=i.start,s=Math.max(0,n.x),a=Math.max(0,n.y),r=Math.min(this.getWidth()-1,i.offset.x),o=r*Math.min(this.getHeight()-1,i.offset.y),h=new pxl.Vector2,u=0,l=this.indexAt(n);e.length=o;for(var c=0;o>c;++c)e[c]=l+u,++u>=r&&(u=0,l=this.indexAt(h.set(s,++a)));return e}}(),i.indexAt=function(t){return t.x+t.y*this.getWidth()},i.positionFrom=function(t){var i=this.getWidth();return new pxl.Vector2(t%i,t/i|0)},i.getImageData=function(t){var i=null;if(t){i=pxl.createImageData(t.offset.x,t.offset.y);for(var e=new pxl.Layout.Layer.Pixel(new pxl.ImageDataArray(i.data.buffer)),n=new pxl.Layout.Layer.Pixel(this.dataLayer.data),s=t.indexes||this.indexesAt(t),a=s.length,r=0,o=0;a>r;++r)e.index=o,n.index=s[r]<<2,e.set(n),o+=4}else i=this._imageData;return i},i.getWidth=function(){return this._imageData.width},i.getHeight=function(){return this._imageData.height},i.visibleLayers=function(){for(var t=[],i=this.layerList,e=0;e<i.length;++e)i[e].isVisible&&t.push(i[e]);return t},i.destroy=function(){for(this.dataLayer.destroy(),this._imageData=this.dataLayer=this.activeLayer=null;this.layerList.length;)this.layerList.pop().destroy()}}(),function(){"use strict";var t=pxl.Layout.Layer=function(t){this.data=new pxl.ImageDataArray("number"==typeof t.source?t.source<<2:t.source),this.name=t.name||"",this.isVisible=!0,this._layout=t.layout},i=t.prototype;i.reset=function(){var t=this.data;if("fill"in pxl.ImageDataArray.prototype)t.fill(0);else for(var i=0,e=t.length;e>i;++i)t[i]=0},i.copy=function(t,i){this.data.set(t.data),i===!0&&(this.name=t.name,this._layout=t._layout,this.isVisible=t.isVisible)},i.merge=function(t){var i=0,e=0,n=t.isMix===!0?"mix":"set",s=new pxl.Layout.Layer.Pixel(this.data),a=new pxl.Layout.Layer.Pixel(t.other.data);if(t.start&&t.offset||t.indexes){var r=t.indexes||this._layout.indexesAt(t);for(e=r.length,i=0;e>i;++i)s.index=a.index=r[i]<<2,s[n](a)}else for(e=this.data.length,i=0;e>i;i+=4)s.index=a.index=i,s[n](a)},i.fill=function(){var t=new pxl.GrowingPool(pxl.Vector2);return function(i){function e(){s.index=u.indexAt(h)<<2,s.compare(a)&&(o.cache(s),s.set(y),r.expand().set(h))}var n=this._layout.indexAt(i.position),s=new pxl.Layout.Layer.Pixel(this.data,n<<2);if(s.compare(i.pixel))return!1;var a=new pxl.ImageDataArray(this.pixelFromIndex(n)),r=t,o=pxl.Layout.history,h=new pxl.Vector2,u=this._layout,l=0,c=0,f=0,x=0;i.start&&i.offset?(l=Math.max(0,i.start.y),c=Math.min(u.getWidth()-1,i.start.x+i.offset.x),x=Math.min(u.getHeight()-1,i.start.y+i.offset.y),f=Math.max(0,i.start.x)):(c=u.getWidth()-1,x=u.getHeight()-1),o.cache(s),s[i.isMix===!0?"mix":"set"](i.pixel);var y=this.pixelFromIndex(n);r.expand().set(i.position);do h.set(r.pop()),h.y>l&&(h.y-=1,e(),h.y+=1),h.x<c&&(h.x+=1,e(),h.x-=1),h.y<x&&(h.y+=1,e(),h.y-=1),h.x>f&&(h.x-=1,e(),h.x+=1);while(r._size);return!0}}(),i.plot=function(t){var i=0,e=0,n=t.pixel,s=pxl.Layout.history,a=t.isMix===!0?"mix":"set",r=new pxl.Layout.Layer.Pixel(this.data);if(t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(e=o.length,i=0;e>i;++i)r.index=o[i]<<2,s.cache(r),r[a](n)}else for(e=this.data.length,i=0;e>i;i+=4)r.index=i,s.cache(r),r[a](n)},i.colorReplace=function(t){var i=0,e=0,n=pxl.Layout.history,s=new pxl.Layout.Layer.Pixel(this.data),a=new pxl.ImageDataArray(t.oldPixel),r=new pxl.Layout.Layer.Pixel(t.oldPixel);if(r[t.isMix===!0?"mix":"set"](t.pixel),t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(e=o.length,i=0;e>i;++i)s.index=o[i]<<2,s.compare(a)&&(n.cache(s),s.set(r))}else for(e=this.data.length,i=0;e>i;i+=4)s.index=i,s.compare(a)&&(n.cache(s),s.set(r))},i.pixelFromPosition=function(t){return this.pixelAt(this._layout.indexAt(t)<<2)},i.pixelFromIndex=function(t){return this.pixelAt(t<<=2)},i.getLayout=function(){return this._layout},i.pixelAt=function(t){return this.data.subarray(t,t+4)},i.destroy=function(){this._layout=this.data=null,this.isVisible=!1,pxl.Layout.history.clean()}}(),function(){"use strict";var t=pxl.Layout.Layer.Pixel=function(t,i){this.data=t,this.index=i||0},i=t.prototype;i.toString=function(){var t=this.data,i=this.index;return t[i]+","+t[++i]+","+t[++i]+","+t[++i]},i.compare=function(t){var i=this.data,e=this.index,n=t.data||t,s=t.index||0;return i[e]===n[s]&&i[++e]===n[++s]&&i[++e]===n[++s]&&i[++e]===n[++s]},i.isOpaque=function(){return 255===this.data[this.index+3]},i.isTransparent=function(){return 0===this.data[this.index+3]},i.set=function(t){var i=this.data,e=this.index,n=t.data||t,s=t.index||0;i[e]=n[s],i[++e]=n[++s],i[++e]=n[++s],i[++e]=n[++s]},i.mix=function(t){var i=this.data,e=this.index,n=t.data||t,s=t.index||0,a=n[s+3];if(0!==a){var r=i[e+3];if(255===a||0===r)return void this.set(t);r/=255,a/=255;var o=r*(1-a),h=a+o,u=a/h,l=o/h;i[e]=i[e++]*u+n[s+0]*l,i[e]=i[e++]*u+n[s+1]*l,i[e]=i[e++]*u+n[s+2]*l,i[e]=255*h}}}(),function(){"use strict";function t(t){return"imageSmoothingEnabled"in t?t.imageSmoothingEnabled=!1:"webkitImageSmoothingEnabled"in t?t.webkitImageSmoothingEnabled=!1:"mozImageSmoothingEnabled"in t?t.mozImageSmoothingEnabled=!1:"msImageSmoothingEnabled"in t&&(t.msImageSmoothingEnabled=!1),t}function i(t){t._buffer=t._layout=null}function e(t,i){return i*(1-t)>>1}var n=pxl.Layout.View=function(t){this._buffer=t.buffer,this._ctx=t.ctx,this._layoutOwner=t.isOwner,this._imagePoint=new pxl.Vector2(0),this._scale=pxl.MIN_ZOOM_SCALE,this._layout=t.layout,this._subscribe()};n.create=function(i){var e=null,s=null,a=null,r=!0;e=i.element?"CANVAS"===i.element.nodeName.toUpperCase()?i.element:i.element.appendChild(pxl.createCanvas()):document.body.appendChild(pxl.createCanvas()),i.source?(s=i.source._buffer.canvas,a=i.source._layout,r=!1):(s=pxl.createCanvas(),s.width=pxl.clamp(i.canvasSize.width,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),s.height=pxl.clamp(i.canvasSize.height,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),a=new pxl.Layout(s.width,s.height).appendLayer());var o=new n({buffer:t(s.getContext("2d")),ctx:t(e.getContext("2d")),isOwner:r,layout:a});return n.instances.push(o),o},n.instances=[];var s=n.prototype;s.render=function(t){return t=t||{},this.clear(t).update(t).redraw(t)},s.drawRect=function(t){var i=t.pixel;return this._ctx.fillStyle="rgba("+i[0]+","+i[1]+","+i[2]+","+i[3]/255+")",this._ctx.fillRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y),this},s.redraw=function(t){return t.start&&t.offset?this._ctx.drawImage(this._buffer.canvas,t.start.x,t.start.y,t.offset.x,t.offset.y,t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.drawImage(this._buffer.canvas,this._imagePoint.x,this._imagePoint.y),this},s.clear=function(t){return t.start&&t.offset?this._ctx.clearRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this},s.update=function(t){return this._layoutOwner&&(t.start&&t.offset?this._buffer.putImageData(this._layout.getImageData(t),t.start.x,t.start.y,0,0,t.offset.x,t.offset.y):this._buffer.putImageData(this._layout.getImageData(),0,0)),this},s.begin=function(){var t=this._scale,i=this._ctx;return i.save(),i.translate(e(t,this._ctx.canvas.width),e(t,this._ctx.canvas.height)),i.scale(t,t),this},s.end=function(){return this._ctx.restore(),this},s.getBufferContext=function(){return this._buffer},s.getScale=function(){return this._scale},s.getElement=function(){return this._ctx.canvas},s.getLayout=function(){return this._layout},s.getImagePoint=function(){return this._imagePoint},s.getScaleOffset=function(){return new pxl.Vector2(e(this._scale,this._ctx.canvas.width),e(this._scale,this._ctx.canvas.height))},s.setScale=function(t){return this._scale=pxl.clamp(t,pxl.MIN_ZOOM_SCALE,pxl.MAX_ZOOM_SCALE),this},s.setLayout=function(t){var i=n.instances;this.deleteLayout(),this._layout=t,this._subscribe(),this._layoutOwner=!0;for(var e=0;e<i.length;++e)if(i[e]!==this&&t===i[e]._layout){this._layoutOwner=!1;break}return this},s.setImagePoint=function(t,i){return this.fitToTransition(this._imagePoint.set(t,i))},s.fitToTransition=function(t){return t.sub(this.getScaleOffset()).div(this._scale).floor(),this},s.resizeElement=function(i,e){return this._ctx.canvas.style.width=i+"px",this._ctx.canvas.style.height=e+"px",this._ctx.canvas.width=i,this._ctx.canvas.height=e,t(this._ctx),this.redraw({})},s.deleteLayout=function(){var t=n.instances;if(this._unsubscribe(),this._layoutOwner){for(var e=0;e<t.length;++e)this!==t[e]&&this._layout===t[e]._layout&&(t[e]._unsubscribe(),i(t[e]));this._layout.destroy(),i(this)}return this},s._subscribe=function(){return this._boundedRender||(this._boundedRender=this.render.bind(this),this._layout.observer.subscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender)),this},s._unsubscribe=function(){return this._layout.observer.unsubscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender),this._boundedRender=null,this},s.destroy=function(){var t=n.instances;this.deleteLayout();for(var i=0;i<t.length;++i)if(this===t[i]){t.splice(i,1);break}}}(),function(){"use strict";pxl.Layout.history={_container:[],_pointer:0,_isRecording:!1,lastSession:null,undo:function(){this._pointer&&this._rewrite(this._container[--this._pointer])},redo:function(){this._pointer<this._container.length&&this._rewrite(this._container[this._pointer++])},cache:function(t){var i=null,e=null;this._isRecording&&(i=this.lastSession.pixelMap,e=t.toString(),e in i?i[e].push(t.index):(this.lastSession.assoc.push(e),i[e]=[t.index]))},isEmptySession:function(){for(var t in this._container[this._pointer].pixelMap)return!0;return!1},record:function(t){this.lastSession||(this.lastSession={pixelMap:{},assoc:[],layer:t}),this._isRecording=!0},stop:function(){this.lastSession.assoc.length&&(this._pointer<pxl.MAX_HISTORY_SIZE?(this._container[this._pointer++]=this.lastSession,this._container.splice(this._pointer,this._container.length)):(this._container.push(this.lastSession),this._container.shift()),this.lastSession=null,this._isRecording=!1)},getCurrentSession:function(){return this._container.length?this._pointer?this._container[this._pointer-1]:this._container[this._pointer]:null},clean:function(){for(var t=this._container,i=null,e=0;e<t.length;)i=t[e],i.layer&&null!==i.layer.data?++e:(i===t[this._pointer]&&(t.length>1?0!==this._pointer&&--this._pointer:this._pointer=0),t.splice(e,1))},_rewrite:function(t){for(var i=new pxl.Layout.Layer.Pixel(t.layer.data),e=new pxl.ImageDataArray(4),n=t.pixelMap,s=null,a=0,r=0,o={},h=[],u=[],l=0,c="";t.assoc.length;)for(c=t.assoc.pop(),e.set(c.split(",")),s=n[c],a=s.length,r=0;a>r;++r)l=i.index=s[r],l in u||(u[l]=!1,c=i.toString(),c in o?o[c].push(l):(h.push(c),o[c]=[l])),i.set(e);t.pixelMap=o,t.assoc=h}}}();