var pxl=function(t){"use strict";var e=null,i=!0,s=null,n=null;try{if(s=t.createElement("CANVAS"),s.width=s.height=1,n=s.getContext("2d"),e=Object.getPrototypeOf(n.getImageData(0,0,1,1).data).constructor,!(new e).buffer)throw new Error}catch(r){i=!1}return{MIN_ZOOM_SCALE:1,MAX_ZOOM_SCALE:64,MIN_PEN_SIZE:1,MAX_PEN_SIZE:5,MIN_CANVAS_SIZE:8,MAX_CANVAS_SIZE:1024,MAX_LAYER_COUNT:8,MAX_HISTORY_SIZE:20,PIXELS_CHANGED_EVENT:"pixelsChanged",ImageDataArray:e,activeView:null,isSupported:function(){return i},clamp:function(t,e,i){return t>i?i:e>t?e:t},createImageData:function(){return n.createImageData.apply(n,arguments)},createCanvas:function(){return s.cloneNode()}}}(document);!function(t){"use strict";function e(t){return 0>t?(0|t)-1:0|t}function i(t){return t+.5|0}function s(t){return t===(0|t)?t:(0|t)+1}if(t){var n=t.Vector2=function(t,e){this.set(t||0,e)};n.EPSILON=1e-10;var r=n.prototype;r.toString=function(){return'{"x":'+this.x+',"y":'+this.y+"}"},r.add=function(t,e){return t instanceof n?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+="number"==typeof e?e:t),this},r.sub=function(t,e){return t instanceof n?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-="number"==typeof e?e:t),this},r.mul=function(t,e){return t instanceof n?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*="number"==typeof e?e:t),this},r.div=function(t,e){return t instanceof n?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/="number"==typeof e?e:t),this},r.set=function(t,e){return t instanceof n?(this.x=t.x,this.y=t.y):(this.x=t,this.y="number"==typeof e?e:t),this},r.cmp=function(t,e){var i=n.EPSILON;return t instanceof n?Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i:Math.abs(this.x-t)<i&&Math.abs(this.y-("number"==typeof e?e:t))<i},r.abs=function(){return this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y),this},r.neg=function(){return this.x>=0&&(this.x=-this.x),this.y>=0&&(this.y=-this.y),this},r.swap=function(t){var e=t.x;return t.x=this.x,this.x=e,e=t.y,t.y=this.y,this.y=e,this},r.floor=function(){return this.x=e(this.x),this.y=e(this.y),this},r.ceil=function(){return this.x=s(this.x),this.y=s(this.y),this},r.round=function(){return this.x=i(this.x),this.y=i(this.y),this},r.hasNaN=function(){return this.x!==this.x||this.y!==this.y},r.hasInfinity=function(){return!isFinite(this.x)||!isFinite(this.y)},r.clone=function(){return new n(this)}}}(pxl),function(t){"use strict";if(t){var e=t.Observer=function(){this._eventBook={}},i=e.prototype;i.subscribe=function(t,e){if(t in this._eventBook){var i=this._eventBook[t];-1===i.indexOf(e)&&i.push(e)}else this._eventBook[t]=[e]},i.unsubscribe=function(t,e){if(t in this._eventBook){var i=this._eventBook[t],s=i.indexOf(e);-1!==s&&i.splice(s,1)}},i.notify=function(t,e){if(t in this._eventBook)for(var i=this._eventBook[t],s=0;s<i.length;++s)i[s](e)}}}(pxl),function(t){"use strict";if(t){var e=t.PrimitivePool=function(t){this._container=["function"==typeof t?t():t],this._size=0},i=e.prototype;i.size=function(){return this._size},i.push=function(t){this._size===this._container.length?this._size=this._container.push(t):this._container[this._size++]=t},i.pop=function(){return 0===this._size?null:this._container[--this._size]},i.at=function(t){return t<this._size||0>t?this._container[t]:null},i.back=function(){return 0===this._size?null:this._container[this._size-1]},i.reduce=function(){this._size=0},i.shrink=function(){this._container.length=this._size},i.free=function(){this._container.length=this._size=0}}}(pxl),function(){"use strict";var t=pxl.Layout=function(){this._imageData=pxl.createImageData.apply(null,arguments),this.dataLayer=new pxl.Layout.Layer({source:this._imageData.data.buffer,layout:this}),this.layerList=[],this.activeLayer=null,this.observer=new pxl.Observer},e=t.prototype;e.appendLayer=function(){return this.layerList.length<pxl.MAX_LAYER_COUNT&&(this.activeLayer=new t.Layer({source:this.getWidth()*this.getHeight(),layout:this,name:"Layer "+this.layerList.length}),this.layerList.push(this.activeLayer)),this},e.deleteLayer=function(){var t=this.layerList;if(1===t.length)t[0].reset();else for(var e=0;e<t.length;++e)if(t[e]===this.activeLayer){t.splice(e,1),this.activeLayer=t[t.length-1];break}return this},e.mergeLayers=function(t){var e={},i=this._visibleLayers(),s=i.length,n=this.dataLayer;if(s){t.start&&t.offset||t.indexes?(e.indexes=t.indexes||this.indexesAt(t),e.other=i[0],e.isMix=!1,n.merge(e),e.isMix=!!t.isMix):n.copy(i[0]);for(var r=1;s>r;++r)e.other=i[r],n.merge(e)}else n.reset();return t.isNotifyView===!0&&this.observer.notify(pxl.PIXELS_CHANGED_EVENT,t),this},e.colorReplace=function(t){return this.activeLayer.colorReplace(t),this.mergeLayers(t),this},e.plot=function(t){return this.activeLayer.plot(t),this.mergeLayers(t),this},e.fill=function(t){return this.activeLayer.fill(t)&&this.mergeLayers(t),this},e.indexesAt=function(){var t=[0];return function(e){var i=t,s=e.start,n=Math.max(0,e.start.x),r=Math.max(0,e.start.y),a=Math.min(this.getWidth()-1,e.offset.x),o=a*Math.min(this.getHeight()-1,e.offset.y),h=new pxl.Vector2,u=0,l=this.indexAt(s);i.length=o;for(var c=0;o>c;++c)i[c]=l+u,++u>=a&&(u=0,l=this.indexAt(h.set(n,++r)));return i}}(),e.indexAt=function(t){return t.x+t.y*this.getWidth()},e.positionFrom=function(t){var e=this.getWidth();return new pxl.Vector2(t%e,t/e|0)},e.getImageData=function(){return this._imageData},e.getWidth=function(){return this._imageData.width},e.getHeight=function(){return this._imageData.height},e._visibleLayers=function(){for(var t=[],e=this.layerList,i=0;i<e.length;++i)e[i].isVisible&&t.push(e[i]);return t},e.destroy=function(){this.dataLayer.destroy(),this.activeLayer=null;for(var e=0;e<this.layerList.length;++e)this.layerList[e].destroy(),this.layerList[e]=null;t.history.clean()}}(),function(){"use strict";var t=pxl.Layout.Layer=function(t){this.data=new pxl.ImageDataArray("number"==typeof t.source?t.source<<2:t.source),this.name=t.name||"",this.isVisible=!0,this._layout=t.layout},e=t.prototype;e.reset=function(){var t=this.data;if("fill"in pxl.ImageDataArray.prototype)t.fill(0);else for(var e=0,i=t.length;i>e;++e)t[e]=0},e.copy=function(t,e){this.data.set(t.data),e===!0&&(this.name=t.name,this._layout=t._layout,this.isVisible=t.isVisible)},e.merge=function(t){var e=0,i=0,s=t.isMix===!0?"mix":"set",n=new pxl.Layout.Layer.Pixel(this.data),r=new pxl.Layout.Layer.Pixel(t.other.data);if(t.start&&t.offset||t.indexes){var a=t.indexes||this._layout.indexesAt(t);for(i=a.length,e=0;i>e;++e)n.index=r.index=a[e]<<2,n[s](r)}else for(i=this.data.length,e=0;i>e;e+=4)n.index=r.index=e,n[s](r)},e.fill=function(){var t=new pxl.PrimitivePool(Number),e=new pxl.PrimitivePool(Number);return function(i){function s(){r.index=c.indexAt(l)<<2,r.compare(a)&&(u.cache(r),r.set(y),o.push(l.x),h.push(l.y))}var n=this._layout.indexAt(i.position),r=new pxl.Layout.Layer.Pixel(this.data,n<<2);if(r.compare(i.pixel))return!1;var a=new pxl.ImageDataArray(this.pixelFromIndex(n)),o=t,h=e,u=pxl.Layout.history,l=new pxl.Vector2,c=this._layout,f=0,x=0,p=0,_=0;i.start&&i.offset?(f=Math.max(0,i.start.y),x=Math.min(c.getWidth()-1,i.start.x+i.offset.x),_=Math.min(c.getHeight()-1,i.start.y+i.offset.y),p=Math.max(0,i.start.x)):(x=c.getWidth()-1,_=c.getHeight()-1),u.cache(r),r[i.isMix===!0?"mix":"set"](i.pixel);var y=this.pixelFromIndex(n);o.push(i.position.x),h.push(i.position.y);do l.set(o.pop(),h.pop()),l.y>f&&(l.y-=1,s(),l.y+=1),l.x<x&&(l.x+=1,s(),l.x-=1),l.y<_&&(l.y+=1,s(),l.y-=1),l.x>p&&(l.x-=1,s(),l.x+=1);while(o._size);return o.reduce(),h.reduce(),!0}}(),e.plot=function(t){var e=0,i=0,s=t.pixel,n=pxl.Layout.history,r=t.isMix===!0?"mix":"set",a=new pxl.Layout.Layer.Pixel(this.data);if(t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(i=o.length,e=0;i>e;++e)a.index=o[e]<<2,n.cache(a),a[r](s)}else for(i=this.data.length,e=0;i>e;e+=4)a.index=e,n.cache(a),a[r](s)},e.colorReplace=function(t){var e=0,i=0,s=pxl.Layout.history,n=new pxl.Layout.Layer.Pixel(this.data),r=new pxl.ImageDataArray(t.oldPixel),a=new pxl.Layout.Layer.Pixel(t.oldPixel);if(a[t.isMix===!0?"mix":"set"](t.pixel),t.start&&t.offset||t.indexes){var o=t.indexes||this._layout.indexesAt(t);for(i=o.length,e=0;i>e;++e)n.index=o[e]<<2,n.compare(r)&&(s.cache(n),n.set(a))}else for(i=this.data.length,e=0;i>e;e+=4)n.index=e,n.compare(r)&&(s.cache(n),n.set(a))},e.pixelFromPosition=function(t){return this.pixelAt(this._layout.indexAt(t)<<2)},e.pixelFromIndex=function(t){return this.pixelAt(t<<=2)},e.getLayout=function(){return this._layout},e.pixelAt=function(t){return this.data.subarray(t,t+4)},e.destroy=function(){this._layout=this.data=null,this.isVisible=!1}}(),function(){"use strict";var t=pxl.Layout.Layer.Pixel=function(t,e){this.data=t,this.index=e||0},e=t.prototype;e.toString=function(){var t=this.data,e=this.index;return t[e]+","+t[++e]+","+t[++e]+","+t[++e]},e.compare=function(t){var e=this.data,i=this.index,s=t.data||t,n=t.index||0;return e[i]===s[n]&&e[++i]===s[++n]&&e[++i]===s[++n]&&e[++i]===s[++n]},e.isOpaque=function(){return 255===this.data[this.index+3]},e.isTransparent=function(){return 0===this.data[this.index+3]},e.set=function(t){var e=this.data,i=this.index,s=t.data||t,n=t.index||0;e[i]=s[n],e[++i]=s[++n],e[++i]=s[++n],e[++i]=s[++n]},e.mix=function(t){var e=this.data,i=this.index,s=t.data||t,n=t.index||0,r=s[n+3];if(0!==r){var a=e[i+3];if(255===r||0===a)return void this.set(t);a/=255,r/=255;var o=a*(1-r),h=r+o,u=r/h,l=o/h;e[i]=e[i++]*u+s[n+0]*l,e[i]=e[i++]*u+s[n+1]*l,e[i]=e[i++]*u+s[n+2]*l,e[i]=255*h}}}(),function(){"use strict";function t(t){return"imageSmoothingEnabled"in t?t.imageSmoothingEnabled=!1:"webkitImageSmoothingEnabled"in t?t.webkitImageSmoothingEnabled=!1:"mozImageSmoothingEnabled"in t?t.mozImageSmoothingEnabled=!1:"msImageSmoothingEnabled"in t&&(t.msImageSmoothingEnabled=!1),t}function e(t,e){return e*(1-t)>>1}var i=pxl.Layout.View=function(t){this._buffer=t.buffer,this._ctx=t.ctx,this._layoutOwner=t.isOwner,this._imagePoint=new pxl.Vector2(0),this._scale=pxl.MIN_ZOOM_SCALE,this._layout=t.layout,this._subscribe()};i.create=function(e){var s=null,n=null,r=null,a=!0;s=e.element?"CANVAS"===e.element.nodeName.toUpperCase()?e.element:e.element.appendChild(pxl.createCanvas()):document.body.appendChild(pxl.createCanvas()),e.source?(n=e.src._buffer.canvas,r=e.src._layout,a=!1):(n=pxl.createCanvas(),n.width=pxl.clamp(e.canvasSize.width,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),n.height=pxl.clamp(e.canvasSize.height,pxl.MIN_CANVAS_SIZE,pxl.MAX_CANVAS_SIZE),r=new pxl.Layout(n.width,n.height).appendLayer());var o=new i({buffer:t(n.getContext("2d")),ctx:t(s.getContext("2d")),isOwner:a,layout:r});return i.instances.push(o),o},i.instances=[];var s=i.prototype;s.render=function(t){return t=t||{},this.clear(t).update(t).redraw(t)},s.drawRect=function(t){var e=t.pixel;return this._ctx.fillStyle="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]/255+")",this._ctx.fillRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y),this},s.redraw=function(t){return t.start&&t.offset?this._ctx.drawImage(this._buffer.canvas,t.start.x,t.start.y,t.offset.x,t.offset.y,t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.drawImage(this._buffer.canvas,this._imagePoint.x,this._imagePoint.y),this},s.clear=function(t){return t.start&&t.offset?this._ctx.clearRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this},s.update=function(t){return this._layoutOwner&&(t.start&&t.offset?this._buffer.putImageData(this._layout.getImageData(t.start.x,t.start.y,t.offset.x,t.offset.y),0,0,t.start.x,t.start.y,t.offset.x,t.offset.y):this._buffer.putImageData(this._layout.getImageData(),0,0)),this},s.begin=function(){var t=this._scale,i=this._ctx;return i.save(),i.translate(e(t,this._ctx.canvas.width),e(t,this._ctx.canvas.height)),i.scale(t,t),this},s.end=function(){return this._ctx.restore(),this},s.getBufferContext=function(){return this._buffer},s.getScale=function(){return this._scale},s.getElement=function(){return this._ctx.canvas},s.getLayout=function(){return this._layout},s.getImagePoint=function(){return this._imagePoint},s.getScaleOffset=function(){return new pxl.Vector2(e(this._scale,this._ctx.canvas.width),e(this._scale,this._ctx.canvas.height))},s.setScale=function(t){return this._scale=pxl.clamp(t,pxl.MIN_ZOOM_SCALE,pxl.MAX_ZOOM_SCALE),this},s.setLayout=function(t){var e=i.instances;this.deleteLayout(),this._layout=t,this._subscribe(),this._layoutOwner=!0;for(var s=0;s<e.length;++s)if(e[s]!==this&&t===e[s]._layout){this._layoutOwner=!1;break}return this},s.setImagePoint=function(t,e){return this.fitToTransition(this._imagePoint.set(t,e))},s.fitToTransition=function(t){return t.sub(this.getScaleOffset()).div(this._scale).floor(),this},s.resizeElement=function(e,i){return this._ctx.canvas.style.width=e+"px",this._ctx.canvas.style.height=i+"px",this._ctx.canvas.width=e,this._ctx.canvas.height=i,t(this._ctx),this.redraw({})},s.deleteLayout=function(){var t=i.instances;if(this._unsubscribe(),this._layout&&this._layoutOwner){for(var e=0;e<t.length;++e)this._layout===t[e]._layout&&(t[e]._layout=null);this._layout.destroy(),this._layout=null}return this},s._subscribe=function(){return this._layout&&!this._boundedRender?(this._boundedRender=this.render.bind(this),this._layout.observer.subscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender),this):void 0},s._unsubscribe=function(){return this._layout?(this._layout.observer.unsubscribe(pxl.PIXELS_CHANGED_EVENT,this._boundedRender),this._boundedRender=null,this):void 0},s.destroy=function(){var t=i.instances;this.deleteLayout();for(var e=0;e<t.length;++e)if(this===t[e]){t.splice(e,1);break}}}(),function(){"use strict";pxl.Layout.history={_MAX_TEMPORARY_STORAGE_SIZE:5,_container:[],_pointer:0,_isRecording:!1,_tempPoolStorage:[],lastSession:null,undo:function(){this._pointer&&this._rewrite(this._container[--this._pointer])},redo:function(){this._pointer<this._container.length&&this._rewrite(this._container[this._pointer++])},cache:function(t){if(this._isRecording){var e=this.lastSession.pixelMap,i=t.toString();i in e||(this.lastSession.assoc.push(i),e[i]=this._tempPoolStorage.length?this._tempPoolStorage.pop():new pxl.PrimitivePool(Number)),e[i].push(t.index)}},isEmptySession:function(){for(var t in this._container[this._pointer].pixelMap)return!0;return!1},record:function(t){this.lastSession||(this.lastSession={pixelMap:{},assoc:[],layer:t}),this._isRecording=!0},stop:function(){if(this.lastSession.assoc.length){var t="",e=this.lastSession.pixelMap;for(t in e)e[t].shrink();if(this._pointer<pxl.MAX_HISTORY_SIZE?(this._container[this._pointer++]=this.lastSession,this._container.splice(this._pointer,this._container.length),this.lastSession=null):(this._container.push(this.lastSession),this.lastSession=this._container.shift()),this.lastSession&&this._tempPoolStorage.length<this._MAX_TEMPORARY_STORAGE_SIZE){e=this.lastSession.pixelMap;for(t in e)e[t].reduce(),this._tempPoolStorage.push(e[t])}this.lastSession=null,this._isRecording=!1}},getCurrentSession:function(){return this._container.length?this._pointer?this._container[this._pointer-1]:this._container[this._pointer]:null},clean:function(){for(var t=this._container,e=0;e<t.length;++e)t[e].layer&&null!==t[e].layer.data||t.splice(e,1)},_rewrite:function(t){for(var e=new pxl.Layout.Layer.Pixel(t.layer.data),i=new pxl.ImageDataArray(4),s=t.pixelMap,n=null,r=0,a=0,o={},h=[],u=[],l=0,c="";t.assoc.length;)for(c=t.assoc.pop(),i.set(c.split(",")),n=s[c]._container,r=s[c].size(),a=0;r>a;++a)l=e.index=n[a],l in u||(u[l]=!1,c=e.toString(),c in o||(h.push(c),o[c]=this._tempPoolStorage.length?this._tempPoolStorage.pop():new pxl.PrimitivePool(Number)),o[c].push(l)),e.set(i);t.pixelMap=o,t.assoc=h}}}(),function(){"use strict";function t(t){return function(){var i=e.getCurrentSession();return i&&(e[t](),i.layer.getLayout().mergeLayers({}).observer.notify(pxl.PIXELS_CHANGED_EVENT,{})),pxl.Layout.controller}}var e=pxl.Layout.history;pxl.Layout.controller={_settings:{current:new pxl.Vector2,previous:new pxl.Vector2,pixel:new pxl.ImageDataArray([0,0,0,255]),pixelSize:pxl.MIN_PEN_SIZE},updateUserPosition:function(t,e){return this._settings.previous.set(this._settings.current),pxl.activeView.fitToTransition(this._settings.current.set(t,e).abs().floor()),this._settings.current.sub(pxl.activeView.getImagePoint()),this},positionUpdated:function(){return!this._settings.previous.cmp(this._settings.current)},plotPixel:function(){var t={start:new pxl.Vector2,offset:new pxl.Vector2,pixel:null,isMix:!0,isNotifyView:!0};return function(e,i){arguments.length?t.start.set(e,i):t.start.set(this._settings.current),t.offset.set(this._settings.pixelSize),t.pixel=this._settings.pixel,pxl.activeView.getLayout().plot(t)}}(),plotLine:function(t,e,i,s){arguments.length||(t=this._settings.current.x,e=this._settings.current.y,i=this._settings.previous.x,s=this._settings.previous.y);for(var n=Math.abs(i-t),r=-Math.abs(s-e),a=i>t?1:-1,o=s>e?1:-1,h=n+r,u=0;this.plotPixel(t,e),t!==i||e!==s;)u=h+h,u>=r&&(h+=r,t+=a),n>=u&&(h+=n,e+=o)},fill:function(t,e){var i=arguments.length?new pxl.Vector2(t,e):new pxl.Vector2(this._settings.current);pxl.activeView.fitToTransition(i),pxl.activeView.getLayout().fill({position:i,pixel:this._settings.pixel,isMix:!0,isNotifyView:!0})},carryPixel:function(){var t={start:new pxl.Vector2,offset:new pxl.Vector2(pxl.MIN_PEN_SIZE),pixel:null};return function(){var e=pxl.activeView;e.getScaleOffset(),e.getScale();return t.start.set(this._settings.previous),e.clear(t).redraw(t),t.offset.set(this._settings.pixelSize),t.start.set(this._settings.current),t.pixel=this._settings.pixel,e.drawRect(t),this}}(),undo:t("undo"),redo:t("redo"),rescale:function(t){var e={};return pxl.activeView.clear(e).setScale(pxl.activeView.getScale()+t).begin().redraw(e).end(),this},setPixelSize:function(t){return this._settings.pixelSize=pxl.clamp(t,pxl.MIN_PEN_SIZE,pxl.MAX_PEN_SIZE),this},setColor:function(t,e,i,s){return this._settings.pixel.set(Array.prototype.slice.call(arguments)),this},record:function(t){return e.record(pxl.activeView.getLayout().activeLayer),t.call(this),e.stop(),this},draw:function(t){return pxl.activeView.begin(),t.call(this),pxl.activeView.end(),this}}}();