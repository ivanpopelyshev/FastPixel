var pxl=function(t){"use strict";var i=!0,e=null,s=null,n=null;try{if(s=t.createElement("CANVAS"),s.width=s.height=1,n=s.getContext("2d"),e=Object.getPrototypeOf(n.getImageData(0,0,1,1).data).constructor,!(new e).buffer)throw new Error}catch(a){i=!1}return{Layout:null,View:null,Point:null,Observer:null,bresenham:null,controller:null,ImageDataArray:e,isSupported:i,createImageData:function(){return n.createImageData.apply(n,arguments)},clamp:function(t,i,e){return t>e?e:i>t?i:t},createCanvas:function(){return s.cloneNode()},extend:function(t,i){var e=function(){};e.prototype=i.prototype,t.prototype=new e,t.prototype.constructor=t}}}(document);!function(t){"use strict";function i(t){var i=0|t;return i!==t&&0>i?--i:i}function e(t){return t+.5|0}function s(t){var i=0|t;return t===i?t:i+1}function n(t){return 0>t||t===-0?-t:t}if(t){var a=t.Point=function(t,i){this.set(t||0,i)};a.EPSILON=1e-10;var r=a.prototype;r.toString=function(){return'{"x":'+this.x+',"y":'+this.y+"}"},r.add=function(t,i){return t instanceof a?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+="number"==typeof i?i:t),this},r.sub=function(t,i){return t instanceof a?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-="number"==typeof i?i:t),this},r.mul=function(t,i){return t instanceof a?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*="number"==typeof i?i:t),this},r.div=function(t,i){return t instanceof a?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/="number"==typeof i?i:t),this},r.set=function(t,i){return t instanceof a?(this.x=t.x,this.y=t.y):(this.x=t,this.y="number"==typeof i?i:t),this},r.cmp=function(t,i){return t instanceof a?n(this.x-t.x)<a.EPSILON&&n(this.y-t.y)<a.EPSILON:n(this.x-t)<a.EPSILON&&n(this.y-("number"==typeof i?i:t))<a.EPSILON},r.abs=function(){return this.x=n(this.x),this.y=n(this.y),this},r.neg=function(){return this.x=-n(this.x),this.y=-n(this.y),this},r.swap=function(t){var i=t.x;return t.x=this.x,this.x=i,i=t.y,t.y=this.y,this.y=i,this},r.floor=function(){return this.x=i(this.x),this.y=i(this.y),this},r.ceil=function(){return this.x=s(this.x),this.y=s(this.y),this},r.round=function(){return this.x=e(this.x),this.y=e(this.y),this},r.hasNaN=function(){return isNaN(this.x)||isNaN(this.y)},r.hasInfinity=function(){return!isFinite(this.x)||!isFinite(this.y)},r.clone=function(){return new a(this)}}}(pxl),function(t){"use strict";if(t){var i=t.Observer=function(){this._eventBook={}},e=i.prototype;e.subscribe=function(t,i){if(t in this._eventBook){var e=this._eventBook[t];-1===e.indexOf(i)&&e.push(i)}else this._eventBook[t]=[i]},e.unsubscribe=function(t,i){if(t in this._eventBook){var e=this._eventBook[t],s=e.indexOf(i);-1!==s&&(e.splice(s,1),0===e.length&&delete this._eventBook[t])}},e.notify=function(t,i){if(t in this._eventBook)for(var e=this._eventBook[t],s=0;s<e.length;++s)e[s](i)}}}(pxl),function(t){"use strict";if(t)var i=t.bresenham={line:function(t,i,e,s,n){var a=e-t;0>a&&(a=-a);var r=s-i;r>=0&&(r=-r);for(var o=e>t?1:-1,h=s>i?1:-1,u=a+r,l=0;n(t,i),t!==e||i!==s;)l=u+u,l>=r&&(u+=r,t+=o),a>=l&&(u+=a,i+=h)},rectangle:function(t,e,s,n,a){t===s||e===n?t===s&&e===n?a(t,e):i.line(t,e,s,e,a):(i.line(t,e,s-1,e,a),i.line(s,e,s,n-1,a),i.line(s,n,t+1,n,a),i.line(t,n,t,e+1,a))},ellipse:function(t,i,e,s,n){var a=e-t;0>a&&(a=-a);var r=s-i;0>r&&(r=-r);var o=1&r,h=4*(1-a)*r*r,u=4*(1+o)*a*a,l=h+u+o*a*a,c=0;t>e&&(t=e,e+=a),i>s&&(i=s),i+=r+1>>1,s=i-o,a=8*a*a,o=8*r*r;do n(e,i),n(t,i),n(t,s),n(e,s),c=l<<1,u>=c&&(++i,--s,l+=u+=a),(c>=h||l<<1>u)&&(++t,--e,l+=h+=o);while(e>=t);for(;r>=i-s;)n(t-1,i),n(e+1,i++),n(t-1,s),n(e+1,s--)}}}(pxl),function(){"use strict";function t(t){return"imageSmoothingEnabled"in t?t.imageSmoothingEnabled=!1:"webkitImageSmoothingEnabled"in t?t.webkitImageSmoothingEnabled=!1:"mozImageSmoothingEnabled"in t?t.mozImageSmoothingEnabled=!1:"msImageSmoothingEnabled"in t&&(t.msImageSmoothingEnabled=!1),t}function i(t){t._buffer=t._layout=null}function e(t,i){return i*(1-t)>>1}var s=pxl.View=function(t,i,e,s){this._buffer=i,this._ctx=t,this._layoutOwner=!!s,this._imagePoint=new pxl.Point,this._scale=1,this._layout=e,this._boundedRender=null,this._subscribe()};s.create=function(i){var e=null,n=null,a=null,r=!0;e="CANVAS"===i.element.nodeName.toUpperCase()?i.element:i.element.appendChild(pxl.createCanvas()),i.source?(n=i.source._buffer.canvas,a=i.source._layout,r=!1):(n=pxl.createCanvas(),n.width=i.canvasSize.width,n.height=i.canvasSize.height,a=new pxl.Layout(n.width,n.height));var o=new s(t(e.getContext("2d")),t(n.getContext("2d")),a,r);return s.instances.push(o),o},s.instances=[],s.activeView=null;var n=s.prototype;n.render=function(t){return this.clear(t).update(t).redraw(t)},n.drawRect=function(t){var i=t.pixel;return this._ctx.fillStyle="rgba("+i[0]+","+i[1]+","+i[2]+","+i[3]/255+")",this._ctx.fillRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y),this},n.redraw=function(t){return t.start&&t.offset?this._ctx.drawImage(this._buffer.canvas,t.start.x,t.start.y,t.offset.x,t.offset.y,t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.drawImage(this._buffer.canvas,this._imagePoint.x,this._imagePoint.y),this},n.clear=function(t){return t.start&&t.offset?this._ctx.clearRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this},n.update=function(t){return this._layoutOwner&&(t.start&&t.offset?this._buffer.putImageData(this._layout.getImageData(t),t.start.x,t.start.y,0,0,t.offset.x,t.offset.y):this._buffer.putImageData(this._layout.getImageData(t),0,0)),this},n.begin=function(){var t=this._scale,i=this._ctx;return i.save(),i.translate(e(t,this._ctx.canvas.width),e(t,this._ctx.canvas.height)),i.scale(t,t),this},n.end=function(){return this._ctx.restore(),this},n.getBufferContext=function(){return this._buffer},n.getScale=function(){return this._scale},n.getElement=function(){return this._ctx.canvas},n.getLayout=function(){return this._layout},n.getImagePoint=function(){return this._imagePoint},n.getScaleOffset=function(){return new pxl.Point(e(this._scale,this._ctx.canvas.width),e(this._scale,this._ctx.canvas.height))},n.setScale=function(t){return t>=1&&(this._scale=0|t),this},n.setLayout=function(t){var i=s.instances;this.deleteLayout(),this._layout=t,this._subscribe(),this._layoutOwner=!0;for(var e=0;e<i.length;++e)if(i[e]!==this&&t===i[e]._layout){this._layoutOwner=!1;break}return this},n.setImagePoint=function(t,i){return this.fitToTransition(this._imagePoint.set(t,i))},n.fitToTransition=function(t){return t.sub(this.getScaleOffset()).div(this._scale).floor(),this},n.resizeElement=function(i,e){return this._ctx.canvas.style.width=i+"px",this._ctx.canvas.style.height=e+"px",this._ctx.canvas.width=i,this._ctx.canvas.height=e,t(this._ctx),this.redraw({})},n.deleteLayout=function(){var t=s.instances;if(this._unsubscribe(),this._layoutOwner){for(var e=0;e<t.length;++e)this!==t[e]&&this._layout===t[e]._layout&&(t[e]._unsubscribe(),i(t[e]));this._layout.destroy(),i(this)}return this},n._subscribe=function(){return this._boundedRender||(this._boundedRender=this.render.bind(this),this._layout.observer.subscribe(pxl.Layout.PIXELS_CHANGED_EVENT,this._boundedRender)),this},n._unsubscribe=function(){return this._layout.observer.unsubscribe(pxl.Layout.PIXELS_CHANGED_EVENT,this._boundedRender),this._boundedRender=null,this},n.destroy=function(){var t=s.instances;this.deleteLayout();for(var i=0;i<t.length;++i)if(this===t[i]){t.splice(i,1);break}}}(),function(){"use strict";var t=pxl.Layout=function(){this._imageData=pxl.createImageData.apply(null,arguments),this.dataLayer=new pxl.Layout.Layer(this._imageData.data.buffer,this),this.layerList=[],this.activeLayer=null,this.observer=new pxl.Observer};t.MAX_LAYER_COUNT=20,t.PIXELS_CHANGED_EVENT="pixelsChanged";var i=t.prototype;i.appendLayer=function(){return this.layerList.length<t.MAX_LAYER_COUNT&&(this.activeLayer=new t.Layer(this.getWidth()*this.getHeight(),this,"Layer "+this.layerList.length),this.layerList.push(this.activeLayer)),this},i.deleteLayer=function(){for(var t=this.layerList,i=0;i<t.length;++i)if(t[i]===this.activeLayer){t.splice(i,1),this.activeLayer.destroy(),this.activeLayer=0===t.length?null:t[t.length-1];break}return this},i.mergeLayers=function(i){var e={},s=this.visibleLayers(),n=s.length,a=this.dataLayer;if(n){e.start=i.start,e.offset=i.offset,e.isMix=!1;for(var r=0;n>r;++r)e.other=s[r],a.merge(e),e.isMix=!!i.isMix}else a.reset();return i.isNotifyView===!0&&this.observer.notify(t.PIXELS_CHANGED_EVENT,i),this},i.colorReplace=function(t){return this.activeLayer.colorReplace(t),this.mergeLayers(t),this},i.set=function(t){return this.activeLayer.set(t),this.mergeLayers(t),this},i.setChannel=function(t){return this.activeLayer.setChannel(t),this.mergeLayers(t),this},i.fill=function(t){return this.activeLayer.fill(t),this.mergeLayers(t),this},i.indexAt=function(t){return t.x+t.y*this.getWidth()},i.positionFrom=function(t){var i=this.getWidth();return new pxl.Point(t%i,t/i|0)},i.getImageData=function(t){return t.start&&t.offset?this.dataLayer.generateImageData(t):this._imageData},i.getWidth=function(){return this._imageData.width},i.getHeight=function(){return this._imageData.height},i.visibleLayers=function(){for(var t=[],i=this.layerList,e=0;e<i.length;++e)i[e].isVisible&&t.push(i[e]);return t},i.fixRange=function(t){var i=t.start,e=t.offset,s=this.getWidth(),n=this.getHeight();return i.x>=s||i.y>=n||e.x<=0||e.y<=0?!1:(i.x<0&&(e.x-=-i.x,i.x=0),i.y<0&&(e.y-=-i.y,i.y=0),i.x+e.x>s&&(e.x=s-i.x),i.y+e.y>n&&(e.y=n-i.y),!(e.x<=0||e.y<=0))},i.__process=function(t,i){if(t.start&&t.offset)for(var e=0,s=t.offset.y,n=this.getWidth()<<2,a=t.offset.x<<2,r=this.indexAt(t.start)<<2,o=0;s>o;++o)e=r+a,i(r,e),r+=n;else i(0,this.dataLayer.data.length)},i.destroy=function(){for(this.dataLayer.destroy(),this._imageData=this.dataLayer=this.activeLayer=null;this.layerList.length;)this.layerList.pop().destroy()}}(),function(){"use strict";var t=pxl.Layout.Layer=function(i,e,s){if(this.data=new pxl.ImageDataArray("number"==typeof i?i<<2:i),this.data.length>t.MAX_BUFFER_SIZE)throw this.data=null,new RangeError;this.name=s||"",this.isVisible=!0,this._layout=e||null};t.MAX_BUFFER_SIZE=16777216;var i=t.prototype;i.reset=function(){var t=this.data;if("fill"in pxl.ImageDataArray.prototype)t.fill(0);else for(var i=0,e=t.length;e>i;++i)t[i]=0},i.copy=function(t,i){this.data.set(t.data),i===!0&&(this.name=t.name,this._layout=t._layout,this.isVisible=t.isVisible)},i.merge=function(t){var i=this,e=t.other.data;if(t.start&&t.offset||t.isMix){var s=t.isMix===!0?"mixAt":"setAt";i._layout.__process(t,function(t,n){for(;n>t;)i[s](t,e[t++],e[t++],e[t++],e[t++])})}else i.data.set(e)},i.colorReplace=function(t){var i=this,e=t.pixel[0],s=t.pixel[1],n=t.pixel[2],a=t.pixel[3],r=t.oldPixel[0],o=t.oldPixel[1],h=t.oldPixel[2],u=t.oldPixel[3];this._layout.__process(t,function(t,l){for(;l>t;t+=4)i.compareAt(t,r,o,h,u)&&i.setAt(t,e,s,n,a)})},i.set=function(t){var i=this,e=(this.data,t.pixel[0]),s=t.pixel[1],n=t.pixel[2],a=t.pixel[3],r=t.isMix===!0?"mixAt":"setAt";this._layout.__process(t,function(t,o){for(;o>t;t+=4)i[r](t,e,s,n,a)})},i.setChannel=function(t){var i=this.data,e=pxl.clamp(t.channelOffset,0,3),s=t.value;this._layout.__process(t,function(t,n){for(;n>t;t+=4)i[t+e]=s})},i.fill=function(){var t=[];return function(i){function e(){s.compareAt(f,_,p,x,g)&&(s.setAt(f,d,v,m,b),L.push(f))}var s=this,n=0,a=this.data.length,r=i.pixel,o=this._layout.indexAt(i.position)<<2;if(!(0>o||o>=a||this.compareAt(o,r[0],r[1],r[2],r[3]))){var h=this._layout.getWidth()<<2,u=0,l=h,c=4,f=0,y=this.pixelAt(o),_=y[0],p=y[1],x=y[2],g=y[3];this[i.isMix===!0?"mixAt":"setAt"](o,r[0],r[1],r[2],r[3]),y=this.pixelAt(o);var d=y[0],v=y[1],m=y[2],b=y[3],L=t;L.push(o),i.start&&i.offset&&(u=pxl.clamp(this._layout.indexAt(i.start),0,a)<<2,a=pxl.clamp(this._layout.indexAt(new pxl.Point(i.start).add(i.offset)),0,a)<<2,n=i.start.x<<2,h=i.start.x+i.offset.x<<2);do o=L.pop(),f=o+c,h>=f%l&&e(),f=o+l,a>f&&e(),f=o-c,f%l>=n&&e(),f=o-l,f>u&&e();while(L.length)}}}(),i.insertData=function(t){var i=0,e=this.data,s=t.data;this._layout.__process(t,function(t,n){for(;n>t;)e[t++]=s[i++]})},i.setAt=function(t,i,e,s,n){var a=this.data;a[t]=i,a[t+1]=e,a[t+2]=s,a[t+3]=n},i.mixAt=function(t,i,e,s,n){if(0!==n){var a=this.data,r=a[t+3];if(0===r)a[t]=i,a[t+1]=e,a[t+2]=s,a[t+3]=n;else{r/=255,n/=255;var o=r*(1-n),h=n+o,u=n/h,l=o/h;a[t]=a[t++]*u+i*l,a[t]=a[t++]*u+e*l,a[t]=a[t++]*u+s*l,a[t]=255*h}}},i.compareAt=function(t,i,e,s,n){var a=this.data;return a[t]===i&&a[t+1]===e&&a[t+2]===s&&a[t+3]===n},i.pixelFromPosition=function(t){return this.pixelAt(this._layout.indexAt(t)<<2)},i.pixelFromIndex=function(t){return this.pixelAt(t<<2)},i.pixelAt=function(t){var i=new pxl.ImageDataArray(4),e=this.data;return i[0]=e[t],i[1]=e[++t],i[2]=e[++t],i[3]=e[++t],i},i.generateImageData=function(t){var i=this._layout,e=t.start&&t.offset?pxl.createImageData(t.offset.x,t.offset.y):pxl.createImageData(i.getWidth(),i.getHeight());return this._generateData(e.data,this.data,t),e},i.cloneData=function(t){return this._generateData(null,this.data,t)},i.getLayout=function(){return this._layout},i._generateData=function(t,i,e){var s=0;return e.start&&e.offset?(t=t||new pxl.ImageDataArray(e.offset.x*e.offset.y<<2),this._layout.__process(e,function(e,n){for(;n>e;)t[s++]=i[e++]})):t?t.set(i):t=new pxl.ImageDataArray(i),t},i.destroy=function(){this._layout=this.data=null,this.isVisible=!1}}(),function(){"use strict";pxl.Layout.history={MAX_HISTORY_SIZE:30,STATIC_SHOT:1,DYNAMIC_SHOT:2,_stack:[],_pointer:0,_lastSession:null,_isRecording:!1,isHistoryEmpty:function(){return 0===this._stack.length},isHistoryFull:function(){return this._stack.length===this.MAX_HISTORY_SIZE},isRecording:function(){return this._isRecording},undo:function(){0!==this._pointer&&this._stack[--this._pointer].rewrite()},redo:function(){this._pointer<this._stack.length&&this._stack[this._pointer++].rewrite()},cache:function(t){this._lastSession.push(t)},record:function(t,i){if(this._isRecording===!0)throw new Error;if(i===pxl.Layout.history.STATIC_SHOT)this._lastSession=new pxl.Layout.history.SessionStatic(t.activeLayer);else{if(i!==pxl.Layout.history.DYNAMIC_SHOT)throw new Error;this._lastSession=new pxl.Layout.history.SessionDynamic(t.activeLayer)}this._isRecording=!0},stop:function(){if(this._isRecording!==!0)throw new Error;this._lastSession.isEmpty()===!1&&(this._pointer<this.MAX_HISTORY_SIZE?(this._stack[this._pointer++]=this._lastSession,this._stack.splice(this._pointer,this._stack.length)):(this._stack.push(this._lastSession),this._stack.shift())),this._isRecording=!1,this._lastSession=null},clean:function(){for(var t=this._stack,i=null,e=0;e<t.length;)i=t[e],i.layer&&null!==i.layer.data?++e:(i===t[this._pointer]&&(t.length>1?0!==this._pointer&&--this._pointer:this._pointer=0),t.splice(e,1))}}}(),function(){"use strict";var t=pxl.Layout.history.Session=function(t){this.layer=t,this._list=[]},i=t.prototype;i.isEmpty=function(){return 0===this._list.length};var e=pxl.Layout.history.SessionDynamic=function(i){t.call(this,i),this._sessionMap={}};pxl.extend(e,t);var s=e.prototype;s.push=function(t){var i=this.layer.data,e=i[t]+","+i[t+1]+","+i[t+2]+","+i[t+3];e in this._sessionMap?this._sessionMap[e].push(t):(this._list.push(e),this._sessionMap[e]=[t])},s.rewrite=function(){for(var t=null,i=this.layer.data,e=null,s=null,n=0,a=0,r=0,o=0,h=0,u=0,l=0,c={},f={},y=[];this._list.length;)for(s=this._list.pop(),t=s.split(","),o=t[0],h=t[1],u=t[2],l=t[3],e=this._colorMap[s],a=e.length,r=0;a>r;++r)n=e[r],n in c||(c[n]=!1,s=i[n]+","+i[n+1]+","+i[n+2]+","+i[n+3],s in f?f[s].push(n):(y.push(s),f[s]=[n])),i[n]=o,i[n+1]=h,i[n+2]=u,i[n+3]=l;this._colorMap=f,this._list=y};var n=pxl.Layout.history.SessionStatic=function(i){t.call(this,i)};pxl.extend(n,t);var a=n.prototype;a.push=function(t){var i=this.layer.getLayout();this._list.push({data:this.layer.cloneData(t),start:t.start?new pxl.Point(t.start):new pxl.Point(0,0),offset:t.offset?new pxl.Point(t.offset):new pxl.Point(i.getWidth(),i.getHeight())})},a.rewrite=function(){var t=this._list[this._list.length-1],i=this.layer.cloneData(t);this.layer.insertData(t),t.data=i}}();