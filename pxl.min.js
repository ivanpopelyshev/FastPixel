var pxl=function(t){"use strict";var e=!0,i=null,n={},s=null,a=null;try{if(Object.seal(n),s=t.createElement("CANVAS"),s.width=s.height=1,a=s.getContext("2d"),i=Object.getPrototypeOf(a.getImageData(0,0,1,1).data).constructor,!(new i).buffer)throw new Error}catch(r){e=!1}var o={Layout:null,View:null,Point:null,Observer:null,bresenham:null,controller:null,emptyOptions:n,ImageDataArray:i,isSupported:e,createImageData:function(){return a.createImageData.apply(a,arguments)},clamp:function(t,e,i){return t>i?i:e>t?e:t},createCanvas:function(){return s.cloneNode()},extend:function(t,e){var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t},imageDataFromImage:function(t){var e=null;return s.width=t.width,s.height=t.height,a.drawImage(t,0,0),e=a.getImageData(0,0,s.width,s.height),s.width=s.height=1,e},disableAntialiasing:function(t){"imageSmoothingEnabled"in t?t.imageSmoothingEnabled=!1:"webkitImageSmoothingEnabled"in t?t.webkitImageSmoothingEnabled=!1:"mozImageSmoothingEnabled"in t?t.mozImageSmoothingEnabled=!1:"msImageSmoothingEnabled"in t&&(t.msImageSmoothingEnabled=!1)},toRGBA:function(t,e,i,n){return t|e<<8|i<<16|n<<24},getR:function(t){return 255&t},getG:function(t){return(65280&t)>>8},getB:function(t){return(16711680&t)>>16},getA:function(t){return 0>t?255-~((4278190080&t)>>24):(4278190080&t)>>24}};return Object.seal(o),o}(document);!function(t){"use strict";function e(t){var e=0|t;return e!==t&&0>e?--e:e}function i(t){return t+.5|0}function n(t){var e=0|t;return t===e?t:e+1}function s(t){return 0>t||t===-0?-t:t}if(t){var a=t.Point=function(t,e){this.set(t||0,e)};a.EPSILON=1e-10;var r=a.prototype;r.toString=function(){return'{"x":'+this.x+',"y":'+this.y+"}"},r.add=function(t,e){return t instanceof a?(this.x+=t.x,this.y+=t.y):(this.x+=t,this.y+="number"==typeof e?e:t),this},r.sub=function(t,e){return t instanceof a?(this.x-=t.x,this.y-=t.y):(this.x-=t,this.y-="number"==typeof e?e:t),this},r.mul=function(t,e){return t instanceof a?(this.x*=t.x,this.y*=t.y):(this.x*=t,this.y*="number"==typeof e?e:t),this},r.div=function(t,e){return t instanceof a?(this.x/=t.x,this.y/=t.y):(this.x/=t,this.y/="number"==typeof e?e:t),this},r.set=function(t,e){return t instanceof a?(this.x=t.x,this.y=t.y):(this.x=t,this.y="number"==typeof e?e:t),this},r.cmp=function(t,e){return t instanceof a?s(this.x-t.x)<a.EPSILON&&s(this.y-t.y)<a.EPSILON:s(this.x-t)<a.EPSILON&&s(this.y-("number"==typeof e?e:t))<a.EPSILON},r.abs=function(){return this.x=s(this.x),this.y=s(this.y),this},r.neg=function(){return this.x=-s(this.x),this.y=-s(this.y),this},r.swap=function(t){var e=t.x;return t.x=this.x,this.x=e,e=t.y,t.y=this.y,this.y=e,this},r.floor=function(){return this.x=e(this.x),this.y=e(this.y),this},r.ceil=function(){return this.x=n(this.x),this.y=n(this.y),this},r.round=function(){return this.x=i(this.x),this.y=i(this.y),this},r.hasNaN=function(){return isNaN(this.x)||isNaN(this.y)},r.hasInfinity=function(){return!isFinite(this.x)||!isFinite(this.y)},r.clone=function(){return new a(this)}}}(pxl),function(t){"use strict";if(t){var e="'method' is not a function!",i=t.Observer=function(){this._eventBook={}},n=i.prototype;n.subscribe=function(t,i){if(!(i instanceof Function))throw new Error(e);if(t in this._eventBook){var n=this._eventBook[t];-1===n.indexOf(i)&&n.push(i)}else this._eventBook[t]=[i]},n.unsubscribe=function(t,i){if(!(i instanceof Function))throw new Error(e);if(t in this._eventBook){var n=this._eventBook[t],s=n.indexOf(i);-1!==s&&(n.splice(s,1),0===n.length&&delete this._eventBook[t])}},n.notify=function(t,e){if(t in this._eventBook)for(var i=this._eventBook[t],n=0;n<i.length;++n)i[n](e)}}}(pxl),function(t){"use strict";if(t){var e=t.bresenham={line:function(t,e,i,n,s){var a=i-t;0>a&&(a=-a);var r=n-e;r>=0&&(r=-r);for(var o=i>t?1:-1,h=n>e?1:-1,u=a+r,l=0;s(t,e),t!==i||e!==n;)l=u+u,l>=r&&(u+=r,t+=o),a>=l&&(u+=a,e+=h)},rectangle:function(t,i,n,s,a){var r=0;t===n||i===s?t===n&&i===s?a(t,i):e.line(t,i,n,i,a):(t>n&&(r=t,t=n,n=r),i>s&&(r=i,i=s,s=r),e.line(t,i,n-1,i,a),e.line(n,i,n,s-1,a),e.line(n,s,t+1,s,a),e.line(t,s,t,i+1,a))},ellipse:function(t,e,i,n,s){var a=i-t,r=a*a;0>a&&(a=-a);var o=n-e,h=o*o;0>o&&(o=-o);var u=1&o,l=(1-a)*h<<2,c=(1+u)*r<<2,f=l+c+u*r,y=0;t>i&&(t=i,i+=a),e>n&&(e=n),e+=o+1>>1,n=e-u,a=r<<3,u=h<<3;do s(i,e),s(t,e),s(t,n),s(i,n),y=f<<1,c>=y&&(++e,--n,f+=c+=a),(y>=l||f<<1>c)&&(++t,--i,f+=l+=u);while(i>=t);for(;o>=e-n;)s(t-1,e),s(i+1,e++),s(t-1,n),s(i+1,n--)}};Object.seal(e)}}(pxl),function(){"use strict";function t(t){t._buffer=t._layout=null}function e(t,e){return e*(1-t)>>1}var i=pxl.View=function(t,e,i,n){this._buffer=e,this._ctx=t,this._layoutOwner=Boolean(n),this._imagePoint=new pxl.Point,this._scale=1,this._layout=i,this._boundedRender=null,this._subscribe(),Object.seal(this)};i.create=function(t){var e=null,n=null,s=null,a=!0,r=null,o=null,h=null;return e="CANVAS"===t.element.nodeName.toUpperCase()?t.element:t.element.appendChild(pxl.createCanvas()),t.source?(n=t.source._buffer.canvas,s=t.source._layout,a=!1):(n=pxl.createCanvas(),n.width=t.layoutSize.width,n.height=t.layoutSize.height,s=new pxl.Layout(n.width,n.height)),o=e.getContext("2d"),h=n.getContext("2d"),pxl.disableAntialiasing(o),pxl.disableAntialiasing(h),r=new i(o,h,s,a),i.instances.push(r),r},i.instances=[],i.activeView=null;var n=i.prototype;n.render=function(t){return this.clear(t).update(t).redraw(t)},n.drawRect=function(t){var e=t.pixel;return this._ctx.fillStyle="rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]/255+")",this._ctx.fillRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y),this},n.redraw=function(t){return t.start&&t.offset?this._ctx.drawImage(this._buffer.canvas,t.start.x,t.start.y,t.offset.x,t.offset.y,t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.drawImage(this._buffer.canvas,this._imagePoint.x,this._imagePoint.y),this},n.clear=function(t){return t.start&&t.offset?this._ctx.clearRect(t.start.x+this._imagePoint.x,t.start.y+this._imagePoint.y,t.offset.x,t.offset.y):this._ctx.clearRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this},n.update=function(t){return this._layoutOwner&&(t.start&&t.offset?this._buffer.putImageData(this._layout.getImageData(t),t.start.x,t.start.y,0,0,t.offset.x,t.offset.y):this._buffer.putImageData(this._layout.getImageData(t),0,0)),this},n.begin=function(){var t=this._scale,i=this._ctx;return i.save(),i.translate(e(t,this._ctx.canvas.width),e(t,this._ctx.canvas.height)),i.scale(t,t),this},n.end=function(){return this._ctx.restore(),this},n.getBufferContext=function(){return this._buffer},n.getScale=function(){return this._scale},n.getElement=function(){return this._ctx.canvas},n.getLayout=function(){return this._layout},n.getImagePoint=function(){return this._imagePoint},n.getScaleOffset=function(){return new pxl.Point(e(this._scale,this._ctx.canvas.width),e(this._scale,this._ctx.canvas.height))},n.setScale=function(t){return t>=1&&(this._scale=0|t),this},n.setLayout=function(t){var e=i.instances;this.deleteLayout(),this._layout=t,this._subscribe(),this._layoutOwner=!0;for(var n=0;n<e.length;++n)if(e[n]!==this&&t===e[n]._layout){this._layoutOwner=!1;break}return this},n.setImagePoint=function(t,e){return this._imagePoint.set(t,e)},n.fitToTransition=function(t){return t.sub(this.getScaleOffset()).div(this._scale).floor(),this},n.resizeElement=function(t,e){return this._ctx.canvas.style.width=t+"px",this._ctx.canvas.style.height=e+"px",this._ctx.canvas.width=t,this._ctx.canvas.height=e,pxl.disableAntialiasing(this._ctx),this},n.deleteLayout=function(){var e=i.instances;if(this._unsubscribe(),this._layoutOwner){for(var n=0;n<e.length;++n)this!==e[n]&&this._layout===e[n]._layout&&(e[n]._unsubscribe(),t(e[n]));this._layout.destroy(),t(this)}return this},n._subscribe=function(){if(null!==this._boundedRender)throw new Error("View instance is already subscribed!");return this._boundedRender=this.render.bind(this),this._layout.observer.subscribe(pxl.Layout.PIXELS_CHANGED_EVENT,this._boundedRender),this},n._unsubscribe=function(){return this._layout.observer.unsubscribe(pxl.Layout.PIXELS_CHANGED_EVENT,this._boundedRender),this._boundedRender=null,this},n.destroy=function(){var t=i.instances;this.deleteLayout();for(var e=0;e<t.length;++e)if(this===t[e]){t.splice(e,1);break}}}(),function(){"use strict";var t=pxl.Layout=function(){this._imageData=pxl.createImageData.apply(null,arguments),this.dataLayer=new pxl.Layout.Layer(this._imageData.data.buffer,this),this.layerList=[],this.activeLayer=null,this.observer=new pxl.Observer,Object.seal(this)};t.PIXELS_CHANGED_EVENT="pixelsChanged";var e=t.prototype;e.insertLayer=function(e){function i(){return new t.Layer(this.getWidth()*this.getHeight(),this)}var n=null;return arguments.length?e>=0&&e<=this.layerList.length&&(n=i.call(this),this.layerList.splice(e,0,n)):(n=i.call(this),this.layerList.push(n)),n},e.setActiveTo=function(t){return t in this.layerList&&(this.activeLayer=this.layerList[t]),this},e.removeAllLayers=function(){for(this.activeLayer=null;this.layerList.length;)this.layerList.pop().destroy();return this},e.deleteLayer=function(){for(var t=this.layerList,e=0;e<t.length;++e)if(t[e]===this.activeLayer){t.splice(e,1),this.activeLayer.destroy(),this.activeLayer=null;break}return this},e.mergeLayers=function(e,i){var n={},s=i||this.getVisibleLayers(),a=s.length,r=this.dataLayer;if(0===a)r.reset();else{n.start=e.start,n.offset=e.offset,n.isMix=!1;for(var o=0;a>o;++o)n.other=s[o],r.merge(n),n.isMix=!!e.isMix}return e.isNotifyView===!0&&this.observer.notify(t.PIXELS_CHANGED_EVENT,e),this},e.colorReplace=function(t){return this.activeLayer.colorReplace(t),this.mergeLayers(t),this},e.set=function(t){return this.activeLayer.set(t),this.mergeLayers(t),this},e.setChannel=function(t){return this.activeLayer.setChannel(t),this.mergeLayers(t),this},e.fill=function(t){return this.activeLayer.fill(t),this.mergeLayers(t),this},e.indexAt=function(t){return t.x+t.y*this.getWidth()},e.positionFrom=function(t){var e=this.getWidth();return new pxl.Point(t%e,t/e|0)},e.getImageData=function(t){return t.start&&t.offset?this.dataLayer.generateImageData(t):this._imageData},e.getWidth=function(){return this._imageData.width},e.getHeight=function(){return this._imageData.height},e.getLayersCount=function(){return this.layerList.length},e.getVisibleLayers=function(){for(var t=[],e=this.layerList,i=0;i<e.length;++i)e[i].isVisible===!0&&t.push(e[i]);return t},e.fixRange=function(t){var e=t.start,i=t.offset,n=this.getWidth(),s=this.getHeight();return e.x>=n||e.y>=s||i.x<=0||i.y<=0?!1:(e.x<0&&(i.x-=-e.x,e.x=0),e.y<0&&(i.y-=-e.y,e.y=0),e.x+i.x>n&&(i.x=n-e.x),e.y+i.y>s&&(i.y=s-e.y),!(i.x<=0||i.y<=0))},e.__process=function(t,e){if(t.start&&t.offset)for(var i=0,n=t.offset.y,s=this.getWidth()<<2,a=t.offset.x<<2,r=this.indexAt(t.start)<<2,o=0;n>o;++o)i=r+a,e(r,i),r+=s;else e(0,this.dataLayer.data.length)},e.destroy=function(){this.dataLayer.destroy(),this._imageData=this.dataLayer=null,this.removeAllLayers()}}(),function(){"use strict";var t=pxl.Layout.Layer=function(e,i,n){if(this.data=new pxl.ImageDataArray("number"==typeof e?e<<2:e),this.data.length>t.MAX_BUFFER_SIZE)throw this.data=null,new RangeError("Buffer limit has been reached!");this.name=n||"",this.isVisible=!0,this._layout=i||null,Object.seal(this)};t.MAX_BUFFER_SIZE=16777216;var e=t.prototype;e.reset=function(){var t=this.data;if("fill"in pxl.ImageDataArray.prototype)t.fill(0);else for(var e=0,i=t.length;i>e;++e)t[e]=0},e.copyFrom=function(t,e){this.data.set(t.data),e===!0&&(this.name=t.name,this._layout=t._layout,this.isVisible=t.isVisible)},e.merge=function(t){var e=this,i=t.other.data;if(t.start&&t.offset||t.isMix){var n=t.isMix===!0?"mixAt":"setAt";e._layout.__process(t,function(t,s){for(;s>t;)e[n](t,i[t++],i[t++],i[t++],i[t++])})}else e.data.set(i);i=e=n=null},e.colorReplace=function(t){var e=this,i=t.pixel[0],n=t.pixel[1],s=t.pixel[2],a=t.pixel[3],r=t.oldPixel[0],o=t.oldPixel[1],h=t.oldPixel[2],u=t.oldPixel[3];this._layout.__process(t,function(t,l){for(;l>t;t+=4)e.compareAt(t,r,o,h,u)&&e.setAt(t,i,n,s,a)}),e=null},e.set=function(t){var e=this,i=this.data,n=t.pixel[0],s=t.pixel[1],a=t.pixel[2],r=t.pixel[3],o=t.isMix===!0?"mixAt":"setAt";this._layout.__process(t,function(t,i){for(;i>t;t+=4)e[o](t,n,s,a,r)}),e=i=o=null},e.setChannel=function(t){var e=this.data,i=pxl.clamp(t.channelOffset,0,3),n=t.value;this._layout.__process(t,function(t,s){for(;s>t;t+=4)e[t+i]=n}),e=null},e.fill=function(){var t=[];return function(e){function i(){n.compareAt(f,_,x,p,g)&&(n.setAt(f,d,v,m,b),L.push(f))}var n=this,s=0,a=this.data.length,r=e.pixel,o=this._layout.indexAt(e.position)<<2;if(!(0>o||o>=a||this.compareAt(o,r[0],r[1],r[2],r[3]))){var h=this._layout.getWidth()<<2,u=0,l=h,c=4,f=0,y=this.pixelAt(o),_=y[0],x=y[1],p=y[2],g=y[3];this[e.isMix===!0?"mixAt":"setAt"](o,r[0],r[1],r[2],r[3]),y=this.pixelAt(o);var d=y[0],v=y[1],m=y[2],b=y[3],L=t;L.push(o),e.start&&e.offset&&(u=pxl.clamp(this._layout.indexAt(e.start),0,a)<<2,a=pxl.clamp(this._layout.indexAt(new pxl.Point(e.start).add(e.offset)),0,a)<<2,s=e.start.x<<2,h=e.start.x+e.offset.x<<2);do o=L.pop(),f=o+c,h>=f%l&&i(),f=o+l,a>f&&i(),f=o-c,f%l>=s&&i(),f=o-l,f>u&&i();while(L.length);n=null}}}(),e.insertData=function(t){var e=0,i=this.data,n=t.data;this._layout.__process(t,function(t,s){for(;s>t;)i[t++]=n[e++]}),i=n=null},e.setAt=function(t,e,i,n,s){var a=this.data;a[t]=e,a[t+1]=i,a[t+2]=n,a[t+3]=s},e.mixAt=function(t,e,i,n,s){if(0!==s){var a=this.data,r=a[t+3];if(0===r)a[t]=e,a[t+1]=i,a[t+2]=n,a[t+3]=s;else{r/=255,s/=255;var o=r*(1-s),h=s+o,u=s/h,l=o/h;a[t]=a[t++]*u+e*l,a[t]=a[t++]*u+i*l,a[t]=a[t++]*u+n*l,a[t]=255*h}}},e.compareAt=function(t,e,i,n,s){var a=this.data;return a[t]===e&&a[t+1]===i&&a[t+2]===n&&a[t+3]===s},e.pixelFromPosition=function(t){return this.pixelAt(this._layout.indexAt(t)<<2)},e.pixelFromIndex=function(t){return this.pixelAt(t<<2)},e.pixelAt=function(t){var e=new pxl.ImageDataArray(4),i=this.data;return e[0]=i[t],e[1]=i[++t],e[2]=i[++t],e[3]=i[++t],e},e.generateImageData=function(t){var e=this._layout,i=t.start&&t.offset?pxl.createImageData(t.offset.x,t.offset.y):pxl.createImageData(e.getWidth(),e.getHeight());return void this._generateData(i.data,this.data,t),i},e.cloneData=function(t){return this._generateData(null,this.data,t)},e.getLayout=function(){return this._layout},e._generateData=function(t,e,i){var n=0;return i.start&&i.offset?(t=t||new pxl.ImageDataArray(i.offset.x*i.offset.y<<2),this._layout.__process(i,function(i,s){for(;s>i;)t[n++]=e[i++]})):t?t.set(e):t=new pxl.ImageDataArray(e),e=null,t},e.destroy=function(){this._layout=this.data=null,this.isVisible=!1}}(),function(){"use strict";pxl.Layout.history={Session:null,SessionDynamic:null,SessionStatic:null,STATIC_SHOT:1,DYNAMIC_SHOT:2,_stack:[],_pointer:0,_lastSession:null,_isRecording:!1,getHistorySize:function(){return this._stack.length},isRecording:function(){return this._isRecording},undo:function(){this._pointer>0&&this._stack[--this._pointer].rewrite()},redo:function(){this._pointer<this._stack.length&&this._stack[this._pointer++].rewrite()},cache:function(t){this._lastSession.cache(t)},record:function(t,e){if(this._isRecording===!0)throw new Error("Recording has been started before!");if(e===pxl.Layout.history.STATIC_SHOT)this._lastSession=new pxl.Layout.history.SessionStatic(t.activeLayer);else{if(e!==pxl.Layout.history.DYNAMIC_SHOT)throw new Error("Unknown flag!");this._lastSession=new pxl.Layout.history.SessionDynamic(t.activeLayer)}this._isRecording=!0},stop:function(t){if(this._isRecording===!1)throw this.resetRecording(),new Error("Recording has not been started!");this._lastSession.isEmpty()===!1&&(t===!0?(this._stack.push(this._lastSession),this._stack.shift()):(this._stack[this._pointer++]=this._lastSession,this._stack.splice(this._pointer,this._stack.length))),this.resetRecording()},resetRecording:function(){this._isRecording=!1,this._lastSession=null},free:function(){this._lastSession=null,this._stack.length=0,this._pointer=0},clean:function(){for(var t=this._stack,e=null,i=0;i<t.length;)e=t[i],e.layer&&null!==e.layer.data?++i:(e===t[this._pointer]&&(t.length>1?0!==this._pointer&&--this._pointer:this._pointer=0),t.splice(i,1))}},Object.seal(pxl.Layout.history)}(),function(){"use strict";var t=pxl.Layout.history.Session=function(t){this.layer=t},e=pxl.Layout.history.SessionDynamic=function(e){t.call(this,e),this.layer=e,this._indexMap={},Object.seal(this)};pxl.extend(e,t);var i=e.prototype;i.isEmpty=function(){for(var t in this._indexMap)return!1;return!0},i.cache=function(t){function e(t){t in s||(s[t]=pxl.toRGBA(n[t],n[t+1],n[t+2],n[t+3]))}function i(t,i){for(;i>t;)e(t),t+=4}var n=this.layer.data,s=this._indexMap;t.constructor===Number?e(t):t.start&&t.offset?1===t.offset.x&&1===t.offset.y?e(this.layer.getLayout().indexAt(t.start)):this.layer.getLayout().__process(t,i):this.layer.getLayout().__process(pxl.emptyOptions,i)},i.rewrite=function(){var t={},e=0,i=null,n=this.layer,s=this._indexMap;for(var a in s)e=s[a],e in t?i=t[e]:(i=[pxl.getR(e),pxl.getG(e),pxl.getB(e),pxl.getA(e)],t[e]=i),n.setAt(+a,i[0],i[1],i[2],i[3])};var n=pxl.Layout.history.SessionStatic=function(e){t.call(this,e),this._cached=!1,this._cachedOption=null,Object.seal(this)};pxl.extend(n,t);var s=n.prototype;s.isEmpty=function(){return null===this._cachedOption},s.cache=function(t){if(this._cached===!0)throw new Error("Static sessions can be cached only once!");this._cached=!0,t.start&&t.offset?this._cachedOption={data:this.layer.cloneData(t),start:t.start.clone(),offset:t.offset.clone()}:this._cachedOption={data:this.layer.cloneData(t)}},s.rewrite=function(){var t=this._cachedOption,e=this.layer.cloneData(t);this.layer.insertData(t),t.data=e}}();