<!DOCTYPE html>
<html lang="en">
	<head>
		<title>FAST PIXEL API DEMO</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
		<link rel="stylesheet" href="common.css"/>
		<style>
			#duplicate{
				position: absolute;
				right: 0;
			}
		</style>
	</head>
	<body>
		<canvas id="main" width="512" height="512"></canvas>
		<canvas id="duplicate" width="128" height="128"></canvas>

		<script src="../pxl.js"></script>
		<script src="common.js"></script>
		<script>
			var canvas = document.querySelectorAll("CANVAS")[0];
			var isMouseDown = false;

			//make sure that the current browser is cool:
			if (pxl.isSupported()){

				//create the new View instance, and set it as active:
				var activeView = pxl.activeView = pxl.Layout.View.create({
					canvasSize: {
						width: 128,
						height: 128
					},
					element: canvas
				});

				pxl.Layout.View.create({
					source: activeView,
					element: document.querySelectorAll("CANVAS")[1]
				});

				pxl.bresenham.rectangle(0, 0, 127, 127, common.plotPixel);

				common.setColor([0, 0, 255, 255]);

				activeView.setImagePoint(190, 190);

				common.rescale(2);

				//listen for some of user movements:
				document.addEventListener("mousedown", userDownMouse, false);
				document.addEventListener("mouseup", userUpMouse, false);
				document.addEventListener("wheel", userWheel, false);
				document.addEventListener("keypress", userKey, false);
				canvas.addEventListener("mousemove", userMove, false);
			} else{
				alert("Not supported!"); //old IE or something like that
			}

			function userDownMouse(e){
				isMouseDown = true;
				common.startDraw().plotPixel();
			};

			function userUpMouse(e){
				isMouseDown = false;
				common.stopDraw();
			};

			function userMove(e){
				common.updateUserPosition(e.pageX, e.pageY);
				if (common.positionUpdated() && common.isWithinLayout()){
					if (isMouseDown){
						pxl.bresenham.line(
							common.settings.current.x,
							common.settings.current.y,
							common.settings.previous.x,
							common.settings.previous.y,
							common.plotPixel
						);
					} else {
						common.draw(function(){
							this.carryPixel(); //draw pixel under cursor
						});
					}
				}
			};

			function userWheel(e){
				var dt = e.deltaY || e.detail || e.wheelDelta;
				common.rescale(dt > 0 ? -1 : 1); //change scale by mouse wheel
			};

			function userKey(e){
				if (e.which === 100){
					common.removeActiveView();
					document.removeEventListener("mousedown", userDownMouse);
					document.removeEventListener("mouseup", userUpMouse);
					document.removeEventListener("wheel", userWheel);
					canvas.removeEventListener("mousemove", userMove);
				} else if (e.which === 121){
					common.draw(common.redo);
				} else if (e.which === 122){
					common.draw(common.undo);
				}
			};
		</script>
		<p>draw on the left canvas and then, press 'd' key to delete active view instance</p>
	</body>
</html>