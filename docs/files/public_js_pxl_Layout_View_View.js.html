<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public\js\pxl\Layout\View\View.js - FastPixel doc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="FastPixel doc" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/controller.html">controller</a></li>
                                <li><a href="../classes/history.html">history</a></li>
                                <li><a href="../classes/Layer.html">Layer</a></li>
                                <li><a href="../classes/Layout.html">Layout</a></li>
                                <li><a href="../classes/Observer.html">Observer</a></li>
                                <li><a href="../classes/Pixel.html">Pixel</a></li>
                                <li><a href="../classes/PrimitivePool.html">PrimitivePool</a></li>
                                <li><a href="../classes/pxl.html">pxl</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/pxl.html">pxl</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: public\js\pxl\Layout\View\View.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
(function(){
	&quot;use strict&quot;;

	/**
	 * pxl.Layout.View
	 *
	 * @constructor
	 * @class View
	 * @param options {Object} [in]
	 * @param options.buffer {CanvasRenderingContext2D}
	 * @param options.ctx {CanvasRenderingContext2D}
	 * @param options.layout {Layout}
	 * @param options.isOwner {Boolean}
	 */
	var View = pxl.Layout.View = function(options){
		/**
		 * @property _buffer
		 * @private
		 * @type {CanvasRenderingContext2D}
		 */
		this._buffer = options.buffer;

		/**
		 * @property _ctx
		 * @private
		 * @type {CanvasRenderingContext2D}
		 */
		this._ctx = options.ctx;

		/**
		 * @property _layoutOwner
		 * @private
		 * @type {Boolean}
		 */
		this._layoutOwner = options.isOwner;

		/**
		 * @property _imagePoint
		 * @private
		 * @type {Vector2}
		 */
		this._imagePoint = new pxl.Vector2(0);

		/**
		 * @property _scale
		 * @private
		 * @type {Number}
		 */
		this._scale = pxl.MIN_ZOOM_SCALE;

		/**
		 * @property _layout
		 * @private
		 * @type {Layout}
		 */
		this._layout = options.layout;

		/**
		 * @property _boundedRender
		 * @private
		 * @type {Function}
		 */
		this._subscribe();
	};

	/**
	 * Simple factory-like method
	 * Take care about view creating and DOM manipulations
	 * Also put new instance into static &quot;instances&quot; list
	 *
	 * @static
	 * @method create
	 * @param options {Object} [in]
	 * @return {View}
	 */
	View.create = function(options){
		var canvas = null;
		var bufferCanvas = null;
		var layout = null;
		var isOwner = true;
		if (options.element){
			if (options.element.nodeName.toUpperCase() === &quot;CANVAS&quot;){
				canvas = options.element
			} else{
				canvas = options.element.appendChild(pxl.createCanvas());
			}
		} else{
			canvas = document.body.appendChild(pxl.createCanvas());
		}
		if (options.source){
			bufferCanvas = options.src._buffer.canvas;
			layout = options.src._layout;
			isOwner = false;
		} else{
			bufferCanvas = pxl.createCanvas();
			bufferCanvas.width = pxl.clamp(
				options.canvasSize.width,
				pxl.MIN_CANVAS_SIZE, pxl.MAX_CANVAS_SIZE
			);
			bufferCanvas.height = pxl.clamp(
				options.canvasSize.height,
				pxl.MIN_CANVAS_SIZE, pxl.MAX_CANVAS_SIZE
			);
			layout = new pxl.Layout(
				bufferCanvas.width, bufferCanvas.height
			).appendLayer();
		}
		var view = new View({
			&quot;buffer&quot;: _setupContext(bufferCanvas.getContext(&quot;2d&quot;)),
			&quot;ctx&quot;: _setupContext(canvas.getContext(&quot;2d&quot;)),
			&quot;isOwner&quot;: isOwner,
			&quot;layout&quot;: layout
		});
		View.instances.push(view);
		return view;
	};

	/**
	 * List of all existing View instances
	 *
	 * @property instances
	 * @static
	 * @type {Array}
	 */
	View.instances = [];

	var viewProto = View.prototype;
 
	/**
	 * Update imageData and draw.
	 *
	 * @method render
	 * @param options {Object|undefined}
	 * @chainable
	 */
	viewProto.render = function(options){
		options = options || {};
		return this.clear(options).update(options).redraw(options);
	};

	/**
	 * @method drawRect
	 * @param options {Object} [in]
	 * @param options.start {Vector2}
	 * @param options.offset {Vector2}
	 * @param options.pixel {ImageDataArray}
	 * @chainable
	 */
	viewProto.drawRect = function(options){
		var pixel = options.pixel;
		this._ctx.fillStyle = &quot;rgba(&quot; +
			pixel[0] + &quot;,&quot; + 	//r
			pixel[1] + &quot;,&quot; + 	//g
			pixel[2] + &quot;,&quot; + 	//b
			(pixel[3] / 255) +	//a
		&quot;)&quot;;
		this._ctx.fillRect(
			options.start.x + this._imagePoint.x,
			options.start.y + this._imagePoint.y,

			options.offset.x, options.offset.y
		);
		return this;
	};

	/**
	 * Just redraw old/previous imageData.
	 *
	 * @method redraw
	 * @param options {Object} [in]
	 * @param options.start {Vector2}
	 * @param options.offset {Vector2}
	 * @chainable
	 */
	viewProto.redraw = function(options){
		var point = new pxl.Vector2;
		if (options.start &amp;&amp; options.offset){
			this.fitToTransition(point.set(options.start));
			point.abs();
			this._ctx.drawImage(
				this._buffer.canvas,
				point.x, point.y, //from
				options.offset.x, options.offset.y,

				options.start.x + this._imagePoint.x, //to
				options.start.y + this._imagePoint.y,

				options.offset.x, options.offset.y
			);
		} else{
			this._ctx.drawImage(
				this._buffer.canvas,
				this._imagePoint.x, this._imagePoint.y
			);
		}
		return this;
	};

	/**
	 * @method clear
	 * @param options {Object} [in]
	 * @param options.start {Vector2}
	 * @param options.offset {Vector2}
	 * @chainable
	 */
	viewProto.clear = function(options){
		if (options.start &amp;&amp; options.offset){
			this._ctx.clearRect(
				options.start.x + this._imagePoint.x,
				options.start.y + this._imagePoint.y,

				options.offset.x, options.offset.y
			);
		} else{
			this._ctx.clearRect(
				0, 0, this._ctx.canvas.width, this._ctx.canvas.height
			);
		}
		return this;
	};

	/**
	 * Update the buffer from layout.
	 *
	 * @method update
	 * @param options {Object} [in]
	 * @param options.start {Vector2}
	 * @param options.offset {Vector2}
	 * @chainable
	 */
	viewProto.update = function(options){
		if (this._layout &amp;&amp; this._layoutOwner){
			if (options.start &amp;&amp; options.offset){
				this._buffer.putImageData(
					this._layout.getImageData(
						options.start.x, options.start.y,
						options.offset.x, options.offset.y
					),
					0, 0
				);
			} else{
				this._buffer.putImageData(this._layout.getImageData(), 0, 0);
			}
		}
		return this;
	};

	/**
	 * Transform canvas to scale offset.
	 *
	 * @method begin
	 * @chainable
	 */
	viewProto.begin = function(){
		var scale = this._scale;
		var ctx = this._ctx;
		ctx.save();
		ctx.translate(
			_offset(scale, this._ctx.canvas.width),
			_offset(scale, this._ctx.canvas.height)
		);
		ctx.scale(scale, scale);
		return this;
	};

	/**
	 * Restore.
	 *
	 * @method end
	 * @chainable
	 */
	viewProto.end = function(){
		this._ctx.restore();
		return this;
	};

	/**
	 * @method getBufferContext
	 * @return {CanvasRenderingContext2D}
	 */
	viewProto.getBufferContext = function(){
		return this._buffer;
	};

	/**
	 * @method getScale
     * @return {Number}
     */
    viewProto.getScale = function(){
        return this._scale;
    };

	/**
	 * @method getElement
     * @return {HTMLCanvasElement}
     */
    viewProto.getElement = function(){
        return this._ctx.canvas;
    };

	/**
	 * @method getLayout
     * @return {Layout}
     */
    viewProto.getLayout = function(){
        return this._layout;
    };

	/**
	 * @method getImagePoint
	 * @return {Vector2}
	 */
	viewProto.getImagePoint = function(){
		return this._imagePoint;
	};

	/**
	 * @method getScaleOffset
	 * @return {Vector2}
	 */
	viewProto.getScaleOffset = function(){
		return new pxl.Vector2(
			_offset(this._scale, this._ctx.canvas.width),
			_offset(this._scale, this._ctx.canvas.height)
		);
	};

	/**
	 * Change current scale rate value.
	 *
	 * @method setScale
	 * @param scale {Number} [in]
	 * @chainable
	 */
	viewProto.setScale = function(scale){
		this._scale = pxl.clamp(scale, pxl.MIN_ZOOM_SCALE, pxl.MAX_ZOOM_SCALE);
		return this;
	};

	/**
	 * @method setLayout
	 * @param otherLayout {Layout} [in]
	 * @chainable
	 */
	viewProto.setLayout = function(otherLayout){
		var instances = View.instances;
		this.deleteLayout();
		this._layout = otherLayout; //set to new one
		this._subscribe();
		this._layoutOwner = true;
		for (var i = 0; i &lt; instances.length; ++i){
			if (instances[i] !== this &amp;&amp; //looking for same layout
				otherLayout === instances[i]._layout){
				this._layoutOwner = false;
				break;
			}
		}
		return this;
	};

	/**
	 * @method setImagePoint
	 * @param x {Number} [in]
	 * @param y {Number} [in]
	 * @chainable
	 */
	viewProto.setImagePoint = function(x, y){
		return this.fitToTransition(this._imagePoint.set(x, y));
	};

	/**
	 * @method fitToTransition
	 * @param position {Vector2} [out]
	 * @chainable
	 */
	viewProto.fitToTransition = function(position){
		position.sub(this.getScaleOffset())
		.div(this._scale)
		.floor();
		return this;
	};

	/**
     * Resize and redraw.
	 *
	 * @method resizeElement
	 * @param width {Number}
	 * @param height {Number}
	 * @chainable
     */
    viewProto.resizeElement = function(width, height){
		this._ctx.canvas.style.width = width + &quot;px&quot;;
		this._ctx.canvas.style.height = height + &quot;px&quot;;
		this._ctx.canvas.width = width;
		this._ctx.canvas.height = height;
		_setupContext(this._ctx);
		return this.redraw({});
    };

	/**
	 * @method deleteLayout
	 * @chainable
	 */
	viewProto.deleteLayout = function(){
		var instances = View.instances;
		this._unsubscribe();
		if (this._layout &amp;&amp; this._layoutOwner){
			for (var i = 0; i &lt; instances.length; ++i){
				if (this._layout === instances[i]._layout){
					instances[i]._layout = null;
				}
			}
			this._layout.destroy();
			this._layout = null;
		}
		return this;
	};

    /**
     * Subscribe on events that fired when model (layout) has been changed.
	 *
	 * @method _subscribe
	 * @private
	 * @chainable
     */
    viewProto._subscribe = function(){
        if (!this._layout || this._boundedRender){
			return;
		}
		this._boundedRender = this.render.bind(this);
		this._layout.observer.subscribe(
			pxl.PIXELS_CHANGED_EVENT, this._boundedRender
		);
		return this;
    };

    /**
     * Unsubscribe from all events.
	 *
	 * @method _unsubscribe
	 * @private
	 * @chainable
     */
    viewProto._unsubscribe = function(){
		if (!this._layout){
			return;
		}
		this._layout.observer.unsubscribe(
			pxl.PIXELS_CHANGED_EVENT, this._boundedRender
		);
		this._boundedRender = null;
		return this;
    };

	/**
	 * @destructor
	 * @method destroy
	 */
	viewProto.destroy = function(){
		var instances = View.instances;
		this.deleteLayout();
		for (var i = 0; i &lt; instances.length; ++i){
			if (this === instances[i]){
				instances.splice(i, 1);
				break;
			}
		}
	};

	//Helper
	//Disable default image smoothing
	function _setupContext(dest){
		if (&quot;imageSmoothingEnabled&quot; in dest){
			dest.imageSmoothingEnabled = false;
		} else if (&quot;webkitImageSmoothingEnabled&quot; in dest){
			dest.webkitImageSmoothingEnabled = false;
		} else if (&quot;mozImageSmoothingEnabled&quot; in dest){
			dest.mozImageSmoothingEnabled = false;
		} else if (&quot;msImageSmoothingEnabled&quot; in dest){
			dest.msImageSmoothingEnabled = false;
		}
		return dest;
	};

	//Helper
	function _offset(scale, side){
		return (side * (1 - scale)) &gt;&gt; 1;
	}
})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
